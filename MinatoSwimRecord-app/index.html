<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Á´∂Ê≥≥Ë®òÈå≤ÁÆ°ÁêÜ„ÉªÂàÜÊûê„ÉªÁõÆÊ®ôË®≠ÂÆö„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>üèä‚Äç‚ôÇÔ∏è MinatoSwimRecord - Á´∂Ê≥≥Ë®òÈå≤ÁÆ°ÁêÜ„Ç¢„Éó„É™ - üöÄFIXED-1415üöÄ</title>
    <!-- <link rel="manifest" href="manifest.json"> -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüèä‚Äç‚ôÇÔ∏è%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüèä‚Äç‚ôÇÔ∏è%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <!-- ÁõÆÊ®ôÁÆ°ÁêÜÊ©üËÉΩ -->
    <script src="./targets/target-manager.js"></script>
    <script>
        // Chart.js annotation„Éó„É©„Ç∞„Ç§„É≥„ÇíÁôªÈå≤
        Chart.register(ChartjsPluginAnnotation);
        
        // Èñ¢Êï∞„ÇíÂç≥Â∫ß„Å´„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆ
        window.showTab = window.showTab || function(tabName) {
            console.log('Fallback showTab called with:', tabName);
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .header h1 {
            color: #2563eb;
            font-size: 2.2em;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 1em;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
            touch-action: manipulation;
        }

        .nav-tab.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
            min-height: 48px;
            touch-action: manipulation;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            padding: 12px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            touch-action: manipulation;
            min-height: 48px;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            padding: 8px 12px;
            font-size: 14px;
            min-height: 36px;
        }

        .btn-danger:hover {
            background: #b91c1c;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .record-table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        .record-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .record-table th,
        .record-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .record-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        .record-table tr:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .stat-card p {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 33% { content: '.'; }
            34%, 66% { content: '..'; }
            67%, 100% { content: '...'; }
        }

        .install-prompt {
            background: rgba(37, 99, 235, 0.1);
            border: 2px solid #2563eb;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .install-prompt.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .nav-tabs {
                padding: 3px;
            }
            
            .nav-tab {
                padding: 10px 6px;
                font-size: 0.8em;
            }
            
            .content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card h3 {
                font-size: 1.6em;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .record-table th,
            .record-table td {
                padding: 8px 4px;
                font-size: 0.8em;
            }
            
            /* „É¢„Éê„Ç§„É´Áî®„Ç∞„É©„Éï„Çµ„Ç§„Ç∫Ë™øÊï¥ */
            .chart-container div {
                height: 400px !important;
            }
            
            /* „É¢„Éê„Ç§„É´Áî®ÁõÆÊ®ôÂü∫Ê∫ñÁ∑öÈ†òÂüü„ÅÆÁ∏¶„Çµ„Ç§„Ç∫Ë™øÊï¥ */
            #target-legend {
                margin-top: 15px !important;
                padding: 8px !important;
                max-height: 140px;
                overflow-y: auto;
            }
            
            #target-legend h4 {
                font-size: 12px !important;
                margin-bottom: 8px !important;
            }
            
            #target-legend-content {
                grid-template-columns: 1fr !important;
                gap: 4px !important;
                font-size: 11px !important;
            }
            
            #target-legend-content div {
                padding: 1px 2px !important;
                line-height: 1.1 !important;
                margin: 0 !important;
            }
            
            #target-legend-content svg {
                width: 16px !important;
                height: 6px !important;
                margin-right: 3px !important;
                flex-shrink: 0;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .nav-tab {
                font-size: 0.75em;
                padding: 8px 4px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            /* 480px‰ª•‰∏ã„Åß„ÅÆÁõÆÊ®ôÂü∫Ê∫ñÁ∑öÈ†òÂüü„Çí„Åï„Çâ„Å´„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            #target-legend {
                margin-top: 10px !important;
                padding: 6px !important;
                max-height: 100px;
            }
            
            #target-legend h4 {
                font-size: 11px !important;
                margin-bottom: 6px !important;
            }
            
            #target-legend-content {
                font-size: 10px !important;
                gap: 1px !important;
                line-height: 1 !important;
            }
            
            #target-legend-content div {
                padding: 1px !important;
                margin: 0 !important;
                line-height: 1 !important;
            }
            
            #target-legend-content svg {
                width: 14px !important;
                height: 4px !important;
                margin-right: 2px !important;
                flex-shrink: 0;
            }
            
            /* ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏È†òÂüü„ÅÆ‰∏äÈÉ®„Éû„Éº„Ç∏„É≥„ÇíËøΩÂä† */
            #advice-section {
                margin-top: 15px !important;
                padding: 15px !important;
            }
        }
    </style>
</head>
<body>
    <div class="install-prompt" id="install-prompt">
        <p>üì± „Åì„ÅÆ„Ç¢„Éó„É™„Çí„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åß„Åç„Åæ„ÅôÔºÅ</p>
        <button class="btn" onclick="installApp()">„Ç¢„Éó„É™„Çí„Ç§„É≥„Çπ„Éà„Éº„É´</button>
        <button class="btn" onclick="hideInstallPrompt()" style="background: #6b7280; margin-left: 10px;">Âæå„Åß</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üèä‚Äç‚ôÇÔ∏è MinatoSwimRecord</h1>
            <p>Á´∂Ê≥≥Ë®òÈå≤ÁÆ°ÁêÜ„ÉªÂàÜÊûê„ÉªÁõÆÊ®ôË®≠ÂÆö„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</button>
            <button class="nav-tab" onclick="showTab('records')">üìù Ë®òÈå≤‰∏ÄË¶ß</button>
            <button class="nav-tab" onclick="showTab('add-record')">‚ûï Ë®òÈå≤ËøΩÂä†</button>
            <button class="nav-tab" onclick="showTab('analysis')">üìà ÂàÜÊûê</button>
            <button class="nav-tab" onclick="showTab('data-manager')">üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <h2>üìä „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-records">-</h3>
                        <p>Á∑èË®òÈå≤Êï∞</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="best-time">-</h3>
                        <p>„Éô„Çπ„Éà„Çø„Ç§„É†(„Éê„Çø„Éï„É©„Ç§50m)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="competitions">-</h3>
                        <p>ÂèÇÂä†Â§ß‰ºöÊï∞</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="first-places">-</h3>
                        <p>1‰ΩçÁç≤ÂæóÊï∞</p>
                    </div>
                </div>
            </div>

            <div id="records" class="tab-content">
                <h2>üìù Ë®òÈå≤‰∏ÄË¶ß</h2>
                <div class="form-row" style="margin-bottom: 15px;">
                    <select id="filter-stroke" onchange="filterRecords()">
                        <option value="">ÂÖ®Á®ÆÁõÆ</option>
                        <option value="„Éê„Çø„Éï„É©„Ç§">„Éê„Çø„Éï„É©„Ç§</option>
                        <option value="Ëá™Áî±ÂΩ¢">Ëá™Áî±ÂΩ¢</option>
                        <option value="ËÉåÊ≥≥„Åé">ËÉåÊ≥≥„Åé</option>
                        <option value="Âπ≥Ê≥≥„Åé">Âπ≥Ê≥≥„Åé</option>
                        <option value="ÂÄã‰∫∫„É°„Éâ„É¨„Éº">ÂÄã‰∫∫„É°„Éâ„É¨„Éº</option>
                    </select>
                    <select id="filter-distance" onchange="filterRecords()">
                        <option value="">ÂÖ®Ë∑ùÈõ¢</option>
                        <option value="50">50m</option>
                        <option value="100">100m</option>
                        <option value="200">200m</option>
                    </select>
                    <select id="filter-pool" onchange="filterRecords()">
                        <option value="">ÂÖ®„Éó„Éº„É´</option>
                    </select>
                    <select id="filter-competition" onchange="filterRecords()">
                        <option value="">ÂÖ®Â§ß‰ºö</option>
                    </select>
                </div>
                <div class="record-table-container">
                    <table class="record-table" id="records-table">
                        <thead>
                            <tr>
                                <th>Êó•‰ªò</th>
                                <th>Á®ÆÁõÆ</th>
                                <th>Ë∑ùÈõ¢</th>
                                <th>„Éó„Éº„É´</th>
                                <th>„Çø„Ç§„É†</th>
                                <th>Â§ß‰ºöÂêç</th>
                                <th>È†Ü‰Ωç</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="records-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="add-record" class="tab-content">
                <h2>‚ûï Ë®òÈå≤ËøΩÂä†</h2>
                <form id="record-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Êó•‰ªò</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="stroke">Á®ÆÁõÆ</label>
                            <select id="stroke" name="stroke" required>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="Ëá™Áî±ÂΩ¢">Ëá™Áî±ÂΩ¢</option>
                                <option value="ËÉåÊ≥≥„Åé">ËÉåÊ≥≥„Åé</option>
                                <option value="Âπ≥Ê≥≥„Åé">Âπ≥Ê≥≥„Åé</option>
                                <option value="„Éê„Çø„Éï„É©„Ç§">„Éê„Çø„Éï„É©„Ç§</option>
                                <option value="ÂÄã‰∫∫„É°„Éâ„É¨„Éº">ÂÄã‰∫∫„É°„Éâ„É¨„Éº</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="distance">Ë∑ùÈõ¢</label>
                            <select id="distance" name="distance" required>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="25">25m</option>
                                <option value="50">50m</option>
                                <option value="100">100m</option>
                                <option value="200">200m</option>
                                <option value="400">400m</option>
                                <option value="800">800m</option>
                                <option value="1500">1500m</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pool">„Éó„Éº„É´</label>
                            <select id="pool" name="pool" required>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="Áü≠Ê∞¥Ë∑Ø">Áü≠Ê∞¥Ë∑Ø(25m)</option>
                                <option value="Èï∑Ê∞¥Ë∑Ø">Èï∑Ê∞¥Ë∑Ø(50m)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="time">„Çø„Ç§„É†</label>
                            <input type="text" id="time" name="time" placeholder="‰æã: 26.15" required>
                        </div>
                        <div class="form-group">
                            <label for="rank">È†Ü‰Ωç</label>
                            <select id="rank" name="rank" onchange="toggleCustomRank()">
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="1">1‰Ωç</option>
                                <option value="2">2‰Ωç</option>
                                <option value="3">3‰Ωç</option>
                                <option value="4">4‰Ωç</option>
                                <option value="5">5‰Ωç</option>
                                <option value="6">6‰Ωç</option>
                                <option value="7">7‰Ωç</option>
                                <option value="8">8‰Ωç</option>
                                <option value="9">9‰Ωç</option>
                                <option value="10">10‰Ωç</option>
                                <option value="custom">„Åù„ÅÆ‰ªñÔºàÊâãÂÖ•ÂäõÔºâ</option>
                            </select>
                            <input type="text" id="custom-rank" name="custom-rank" placeholder="È†Ü‰Ωç„ÇíÂÖ•Âäõ" style="display: none; margin-top: 5px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="competition">Â§ß‰ºöÂêç</label>
                        <select id="competition" name="competition">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="memo">„É°„É¢</label>
                        <input type="text" id="memo" name="memo" placeholder="‰ªªÊÑè">
                    </div>
                    <button type="submit" class="btn">Ë®òÈå≤„ÇíËøΩÂä†</button>
                </form>
            </div>

            <div id="analysis" class="tab-content">
                <h2>üìà ÂàÜÊûê</h2>
                
                <!-- „Ç∞„É©„ÉïÈÅ∏Êäû„Éï„Ç©„Éº„É† -->
                <div class="chart-controls" style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>üìä Ë®òÈå≤„Ç∞„É©„ÉïË®≠ÂÆö</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chart-stroke">Á®ÆÁõÆ</label>
                            <select id="chart-stroke" onchange="updateChart()">
                                <option value="">Á®ÆÁõÆ„ÇíÈÅ∏Êäû</option>
                                <option value="„Éê„Çø„Éï„É©„Ç§">„Éê„Çø„Éï„É©„Ç§</option>
                                <option value="Ëá™Áî±ÂΩ¢">Ëá™Áî±ÂΩ¢</option>
                                <option value="ËÉåÊ≥≥„Åé">ËÉåÊ≥≥„Åé</option>
                                <option value="Âπ≥Ê≥≥„Åé">Âπ≥Ê≥≥„Åé</option>
                                <option value="ÂÄã‰∫∫„É°„Éâ„É¨„Éº">ÂÄã‰∫∫„É°„Éâ„É¨„Éº</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chart-distance">Ë∑ùÈõ¢</label>
                            <select id="chart-distance" onchange="updateChart()">
                                <option value="">Ë∑ùÈõ¢„ÇíÈÅ∏Êäû</option>
                                <option value="50">50m</option>
                                <option value="100">100m</option>
                                <option value="200">200m</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chart-pool">„Éó„Éº„É´</label>
                            <select id="chart-pool" onchange="updateChart()">
                                <option value="">„Éó„Éº„É´„ÇíÈÅ∏Êäû</option>
                                <option value="Áü≠Ê∞¥Ë∑Ø">Áü≠Ê∞¥Ë∑Ø</option>
                                <option value="Èï∑Ê∞¥Ë∑Ø">Èï∑Ê∞¥Ë∑Ø</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫„Ç®„É™„Ç¢ -->
                    <div id="debug-info" style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; display: none;">
                        <strong>„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:</strong><br>
                        <span id="debug-content">Chart.jsË™≠„ÅøËæº„ÅøÁä∂Ê≥ÅÁ¢∫Ë™ç‰∏≠...</span>
                    </div>
                    
                    <button onclick="testChart()" class="btn" style="margin-top: 10px; font-size: 14px;">üìä „Ç∞„É©„ÉïÊ©üËÉΩ„ÉÜ„Çπ„Éà</button>
                    <button onclick="clearCache()" class="btn" style="margin-top: 10px; margin-left: 10px; font-size: 14px; background: #dc2626;">üîÑ „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢</button>
                </div>

                <!-- „Ç∞„É©„Éï„Ç®„É™„Ç¢ -->
                <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <div style="position: relative; height: 500px; width: 100%;">
                        <canvas id="recordChart"></canvas>
                    </div>
                    
                    <!-- ÁõÆÊ®ôÂü∫Ê∫ñÁ∑öÂá°‰æã -->
                    <div id="target-legend" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h4 style="margin-bottom: 10px; color: #374151; font-size: 14px;">üéØ ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö</h4>
                        <div id="target-legend-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; font-size: 12px;">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÂá°‰æãÈ†ÖÁõÆ -->
                        </div>
                    </div>
                </div>

                <!-- „Ç¢„Éâ„Éê„Ç§„Çπ„Ç®„É™„Ç¢ -->
                <div id="advice-section" style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <h3>üí™ ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏</h3>
                    <div id="advice-content"></div>
                </div>

                <div id="analysis-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="butterfly-count">-</h3>
                            <p>„Éê„Çø„Éï„É©„Ç§Ë®òÈå≤Êï∞</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="freestyle-count">-</h3>
                            <p>Ëá™Áî±ÂΩ¢Ë®òÈå≤Êï∞</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="recent-improvement">-</h3>
                            <p>Áõ¥Ëøë„ÅÆÂêë‰∏äÁéá</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="best-stroke">-</h3>
                            <p>ÊúÄ„ÇÇÂæóÊÑè„Å™Á®ÆÁõÆ</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="data-manager" class="tab-content">
                <h2>üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="exportData()" style="margin-right: 10px;">üì• „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button class="btn" onclick="importData()">üì§ „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="resetData()" style="background: #dc2626;">üîÑ „Éá„Éº„Çø„É™„Çª„ÉÉ„Éà</button>
                </div>
                <div id="data-info">
                    <p>ÁèæÂú®„ÅÆ„Éá„Éº„Çø‰ª∂Êï∞: <span id="current-data-count">-</span></p>
                    <p>ÊúÄÁµÇÊõ¥Êñ∞: <span id="last-updated">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let records = [];
        let currentTab = 'dashboard';
        let deferredPrompt;

        // ÂàùÊúü„Éá„Éº„Çø„ÅØÂ§ñÈÉ®API„Åã„ÇâÂãïÁöÑË™≠„ÅøËæº„Åø

        // PWA „Ç§„É≥„Çπ„Éà„Éº„É´ÂØæÂøú
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-prompt').classList.add('show');
        });

        window.installApp = function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }

        window.hideInstallPrompt = function() {
            document.getElementById('install-prompt').classList.remove('show');
        }

        // Service Worker ÁôªÈå≤Ôºà‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñÔºâ
        /*
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }
        */

        // „Éá„Éº„ÇøÁÆ°ÁêÜÈñ¢Êï∞
        async function loadFromStorage() {
            const stored = localStorage.getItem('swimRecords');
            if (stored) {
                const data = JSON.parse(stored);
                // „Éá„Éº„Çø„Éê„Éº„Ç∏„Éß„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅÂè§„ÅÑÂ†¥Âêà„ÅØÂº∑Âà∂ÁöÑ„Å´API„Åã„ÇâÂÜçÂèñÂæó
                if (!data.metadata || !data.metadata.version || data.records.length < 183) {
                    console.log('„Éá„Éº„Çø„ÅåÂè§„ÅÑ„Åü„ÇÅ„ÄÅAPI„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åô');
                    localStorage.removeItem('swimRecords');
                    await loadFromAPI();
                } else {
                    records = data.records || [];
                }
            } else {
                // localStorage„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØAPI„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó
                await loadFromAPI();
            }
        }

        async function loadFromAPI() {
            try {
                // GitHub PagesÁí∞Â¢É„Åß„ÅØÁõ¥Êé•JSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø
                const response = await fetch('./data/swim-records.json');
                if (response.ok) {
                    const data = await response.json();
                    records = data.records || [];
                    saveToStorage(); // API„Åã„ÇâÂèñÂæó„Åó„Åü„Éá„Éº„Çø„ÇílocalStorage„Å´‰øùÂ≠ò
                    console.log(`„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${records.length}‰ª∂„ÅÆ„É¨„Ç≥„Éº„Éâ`);
                } else {
                    console.error('JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„ÅÆ„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    records = [];
                }
            } catch (error) {
                console.error('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº:', error);
                records = [];
            }
        }

        function saveToStorage() {
            const data = {
                records: records,
                metadata: {
                    totalRecords: records.length,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0.0"
                }
            };
            localStorage.setItem('swimRecords', JSON.stringify(data));
        }

        function generateId() {
            if (records.length === 0) return '001';
            const maxId = Math.max(...records.map(r => parseInt(r.id)));
            return String(maxId + 1).padStart(3, '0');
        }

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÔºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.showTab = function(tabName) {
            console.log('Real showTab called with:', tabName);
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // event.target„ÅÆ‰ª£„Çè„Çä„Å´„ÄÅÂØæÂøú„Åô„Çã„Éú„Çø„É≥„ÇíÁõ¥Êé•ÂèñÂæó
            const navButtons = document.querySelectorAll('.nav-tab');
            navButtons.forEach((button, index) => {
                const tabNames = ['dashboard', 'records', 'add-record', 'analysis', 'data-manager'];
                if (tabNames[index] === tabName) {
                    button.classList.add('active');
                }
            });
            
            currentTab = tabName;
            
            if (tabName === 'records') {
                renderRecords();
            } else if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'analysis') {
                // ÂàÜÊûê„Çø„Éñ„Å´Âàá„ÇäÊõø„Çè„Å£„ÅüÊôÇ„Å´„Ç∞„É©„Éï„Å®„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                document.querySelector('.chart-container').style.display = 'none';
                document.getElementById('advice-section').style.display = 'none';
                document.getElementById('advice-content').innerHTML = '';
                document.getElementById('debug-info').style.display = 'none';
                updateAnalysis();
            } else if (tabName === 'data-manager') {
                updateDataManager();
            }
        }

        // „É¨„Ç≥„Éº„ÉâË°®Á§∫
        function renderRecords(filteredRecords = null) {
            const tbody = document.getElementById('records-tbody');
            tbody.innerHTML = '';
            
            const recordsToShow = filteredRecords || records;
            
            // Êó•‰ªòÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„Åã„ÇâÔºâ
            const sortedRecords = recordsToShow.sort((a, b) => {
                return new Date(b.Êó•‰ªò) - new Date(a.Êó•‰ªò);
            });
            
            sortedRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.Êó•‰ªò}</td>
                    <td>${record.Á®ÆÁõÆ}</td>
                    <td>${record.Ë∑ùÈõ¢}m</td>
                    <td>${record.„Éó„Éº„É´}</td>
                    <td>${record.„Çø„Ç§„É†}</td>
                    <td>${record.Â§ß‰ºöÂêç}</td>
                    <td>${record.È†Ü‰Ωç}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">ÂâäÈô§</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // „Éï„Ç£„É´„ÇøÊ©üËÉΩÔºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.filterRecords = function() {
            const strokeFilter = document.getElementById('filter-stroke').value;
            const distanceFilter = document.getElementById('filter-distance').value;
            const poolFilter = document.getElementById('filter-pool').value;
            const competitionFilter = document.getElementById('filter-competition').value;
            
            let filtered = records;
            
            if (strokeFilter) {
                filtered = filtered.filter(r => r.Á®ÆÁõÆ === strokeFilter);
            }
            
            if (distanceFilter) {
                filtered = filtered.filter(r => r.Ë∑ùÈõ¢ === distanceFilter);
            }
            
            if (poolFilter) {
                filtered = filtered.filter(r => r.„Éó„Éº„É´ === poolFilter);
            }
            
            if (competitionFilter) {
                filtered = filtered.filter(r => r.Â§ß‰ºöÂêç === competitionFilter);
            }
            
            renderRecords(filtered);
        }

        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊõ¥Êñ∞
        function updateDashboard() {
            console.log('updateDashboard called, records:', records.length);
            
            const totalRecordsElement = document.getElementById('total-records');
            const bestTimeElement = document.getElementById('best-time');
            const competitionsElement = document.getElementById('competitions');
            const firstPlacesElement = document.getElementById('first-places');
            
            if (totalRecordsElement) {
                totalRecordsElement.textContent = records.length;
                console.log('Total records set:', records.length);
            }
            
            const butterflyRecords = records.filter(r => r.Á®ÆÁõÆ === '„Éê„Çø„Éï„É©„Ç§' && r.Ë∑ùÈõ¢ === '50');
            console.log('Butterfly 50m records:', butterflyRecords.length);
            
            if (butterflyRecords.length > 0 && bestTimeElement) {
                const bestTime = Math.min(...butterflyRecords.map(r => parseFloat(r.„Çø„Ç§„É†)));
                bestTimeElement.textContent = bestTime.toFixed(2) + 's';
                console.log('Best time set:', bestTime);
            } else if (bestTimeElement) {
                bestTimeElement.textContent = 'N/A';
            }
            
            const competitions = [...new Set(records.map(r => r.Â§ß‰ºöÂêç))].filter(c => c);
            if (competitionsElement) {
                competitionsElement.textContent = competitions.length;
                console.log('Competitions count:', competitions.length);
            }
            
            const firstPlaces = records.filter(r => r.È†Ü‰Ωç === '1‰Ωç').length;
            if (firstPlacesElement) {
                firstPlacesElement.textContent = firstPlaces;
                console.log('First places count:', firstPlaces);
            }
        }

        // ÂàÜÊûêÁîªÈù¢Êõ¥Êñ∞
        function updateAnalysis() {
            const butterflyCount = records.filter(r => r.Á®ÆÁõÆ === '„Éê„Çø„Éï„É©„Ç§').length;
            const freestyleCount = records.filter(r => r.Á®ÆÁõÆ === 'Ëá™Áî±ÂΩ¢').length;
            
            document.getElementById('butterfly-count').textContent = butterflyCount;
            document.getElementById('freestyle-count').textContent = freestyleCount;
            
            // ÊúÄ„ÇÇÂæóÊÑè„Å™Á®ÆÁõÆ
            const strokeCounts = {};
            records.forEach(r => {
                strokeCounts[r.Á®ÆÁõÆ] = (strokeCounts[r.Á®ÆÁõÆ] || 0) + 1;
            });
            
            const bestStroke = Object.keys(strokeCounts).reduce((a, b) => 
                strokeCounts[a] > strokeCounts[b] ? a : b
            );
            document.getElementById('best-stroke').textContent = bestStroke;
            
            // Áõ¥Ëøë„ÅÆÂêë‰∏äÁéá
            const recentRecords = records
                .filter(r => r.Á®ÆÁõÆ === '„Éê„Çø„Éï„É©„Ç§' && r.Ë∑ùÈõ¢ === '50')
                .sort((a, b) => new Date(b.Êó•‰ªò) - new Date(a.Êó•‰ªò))
                .slice(0, 5);
            
            if (recentRecords.length >= 2) {
                const latest = parseFloat(recentRecords[0].„Çø„Ç§„É†);
                const previous = parseFloat(recentRecords[1].„Çø„Ç§„É†);
                const improvement = ((previous - latest) / previous * 100).toFixed(1);
                document.getElementById('recent-improvement').textContent = improvement + '%';
            } else {
                document.getElementById('recent-improvement').textContent = 'N/A';
            }
        }

        // „Éá„Éº„ÇøÁÆ°ÁêÜÁîªÈù¢Êõ¥Êñ∞
        function updateDataManager() {
            document.getElementById('current-data-count').textContent = records.length;
            const stored = localStorage.getItem('swimRecords');
            if (stored) {
                const data = JSON.parse(stored);
                document.getElementById('last-updated').textContent = 
                    new Date(data.metadata.lastUpdated).toLocaleString('ja-JP');
            }
        }

        // „É¨„Ç≥„Éº„ÉâÂâäÈô§
        function deleteRecord(recordId) {
            if (confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                records = records.filter(r => r.id !== recordId);
                saveToStorage();
                renderRecords();
                updateDashboard();
            }
        }

        // „É¨„Ç≥„Éº„ÉâËøΩÂä†
        document.getElementById('record-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // È†Ü‰Ωç„ÅÆÂÄ§„ÇíÂèñÂæóÔºà„Ç´„Çπ„Çø„É†ÂÖ•Âäõ„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®Ôºâ
            let rankValue = formData.get('rank');
            if (rankValue === 'custom') {
                rankValue = formData.get('custom-rank');
            }
            
            const record = {
                id: generateId(),
                Êó•‰ªò: formData.get('date'),
                Á®ÆÁõÆ: formData.get('stroke'),
                Ë∑ùÈõ¢: formData.get('distance'),
                „Éó„Éº„É´: formData.get('pool'),
                „Çø„Ç§„É†: formData.get('time'),
                Á®ÆÂà•: 'Â§ß‰ºö',
                Â§ß‰ºöÂêç: formData.get('competition'),
                „É¨„Éº„Çπ: '',
                È†Ü‰Ωç: rankValue,
                „É°„É¢: formData.get('memo'),
                ÂÖ•ÂäõËÄÖ: '„É¶„Éº„Ç∂„Éº',
                Êõ¥Êñ∞Êó•ÊôÇ: new Date().toISOString()
            };
            
            records.push(record);
            saveToStorage();
            alert('Ë®òÈå≤„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü');
            e.target.reset();
            
            // „Ç´„Çπ„Çø„É†È†Ü‰ΩçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫„Å´„É™„Çª„ÉÉ„Éà
            document.getElementById('custom-rank').style.display = 'none';
            
            if (currentTab === 'records') {
                renderRecords();
            }
            updateDashboard();
            
            // „Éï„Ç£„É´„Çø„Éº„ÇÇÊõ¥Êñ∞
            populateFilters();
        });

        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.exportData = function() {
            const data = {
                records: records,
                metadata: {
                    totalRecords: records.length,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0.0"
                }
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `swim-records-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„ÉàÔºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.importData = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.records && Array.isArray(data.records)) {
                            records = data.records;
                            saveToStorage();
                            renderRecords();
                            updateDashboard();
                            alert('„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
                        } else {
                            alert('ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô');
                        }
                    } catch (error) {
                        alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // „Éá„Éº„Çø„É™„Çª„ÉÉ„ÉàÔºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.resetData = function() {
            if (confirm('ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂàùÊúüÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                records = initialData.records;
                saveToStorage();
                renderRecords();
                updateDashboard();
                alert('„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
            }
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded started');
            
            try {
                await loadFromStorage();
                console.log('Data loaded, records:', records.length);
                updateDashboard();
                console.log('Dashboard updated');
                
                // ÁõÆÊ®ôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
                if (window.targetManager) {
                    await window.targetManager.initializeTargets();
                    console.log('ÁõÆÊ®ôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
                } else {
                    console.log('targetManager not found');
                }
                
                // ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Éá„Éï„Ç©„É´„Éà„Å´Ë®≠ÂÆö
                const dateInput = document.getElementById('date');
                if (dateInput) {
                    dateInput.valueAsDate = new Date();
                    console.log('Date input set');
                }
                
                console.log('Initialization complete');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        // Service WorkerÁÑ°ÂäπÂåñÔºà„Ç≠„É£„ÉÉ„Ç∑„É•ÂïèÈ°åËß£Ê±∫„ÅÆ„Åü„ÇÅÔºâ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }

        // „Çø„ÉÉ„ÉÅÊìç‰ΩúÊîπÂñÑ
        document.addEventListener('touchstart', function() {}, {passive: true});
        document.addEventListener('touchmove', function() {}, {passive: true});

        // „Ç∞„É©„ÉïÂ§âÊï∞
        let recordChart = null;

        // „Çø„Ç§„É†Â§âÊèõÈñ¢Êï∞ÔºàÂàÜ:ÁßíÂΩ¢Âºè„ÇíÁßíÊï∞„Å´Â§âÊèõÔºâ
        function parseTimeToSeconds(timeString) {
            if (!timeString) return 0;
            
            // Êó¢„Å´ÁßíÊï∞„ÅÆÂ†¥ÂêàÔºàÂ∞èÊï∞ÁÇπ„ÇíÂê´„ÇÄÊï∞ÂÄ§Ôºâ
            if (/^\d+(\.\d+)?$/.test(timeString)) {
                return parseFloat(timeString);
            }
            
            // ÂàÜ:ÁßíÂΩ¢Âºè„ÅÆÂ†¥ÂêàÔºà‰æã: "01:00.08" „Åæ„Åü„ÅØ "1:30.45"Ôºâ
            const timeMatch = timeString.match(/^(\d{1,2}):(\d{2})\.?(\d{2})?$/);
            if (timeMatch) {
                const minutes = parseInt(timeMatch[1], 10);
                const seconds = parseInt(timeMatch[2], 10);
                const hundredths = timeMatch[3] ? parseInt(timeMatch[3], 10) : 0;
                return minutes * 60 + seconds + hundredths / 100;
            }
            
            // „Åù„ÅÆ‰ªñ„ÅÆÂΩ¢ÂºèÔºà‰æã: "26.15"Ôºâ
            return parseFloat(timeString) || 0;
        }

        // ÁßíÊï∞„ÇíÂàÜ:ÁßíÂΩ¢Âºè„Å´Â§âÊèõÔºàË°®Á§∫Áî®Ôºâ
        function formatSecondsToTime(seconds) {
            if (seconds < 60) {
                return seconds.toFixed(2) + 'Áßí';
            } else {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toFixed(2).padStart(5, '0')}`;
            }
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢Èñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.clearCache = function() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
            
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            alert('„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }

        // „Éá„Éê„ÉÉ„Ç∞„Éª„ÉÜ„Çπ„ÉàÈñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.testChart = function() {
            const debugDiv = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            debugDiv.style.display = 'block';
            
            let debug = '';
            
            // Chart.js „ÅÆÁ¢∫Ë™ç
            if (typeof Chart !== 'undefined') {
                debug += '‚úÖ Chart.js Ë™≠„ÅøËæº„ÅøÊàêÂäü<br>';
                debug += `Chart.js „Éê„Éº„Ç∏„Éß„É≥: ${Chart.version}<br>`;
            } else {
                debug += '‚ùå Chart.js „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì<br>';
            }
            
            // CanvasË¶ÅÁ¥†„ÅÆÁ¢∫Ë™ç
            const canvas = document.getElementById('recordChart');
            if (canvas) {
                debug += '‚úÖ CanvasË¶ÅÁ¥†„ÅÇ„Çä<br>';
                debug += `Canvas „Çµ„Ç§„Ç∫: ${canvas.width}x${canvas.height}<br>`;
            } else {
                debug += '‚ùå CanvasË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì<br>';
            }
            
            // „É¨„Ç≥„Éº„Éâ„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
            debug += `üìä Á∑èË®òÈå≤Êï∞: ${records.length}<br>`;
            debug += `„Éê„Çø„Éï„É©„Ç§50mÁü≠Ê∞¥Ë∑Ø: ${records.filter(r => r.Á®ÆÁõÆ === '„Éê„Çø„Éï„É©„Ç§' && r.Ë∑ùÈõ¢ === '50' && r.„Éó„Éº„É´ === 'Áü≠Ê∞¥Ë∑Ø').length}‰ª∂<br>`;
            
            // Á∞°Âçò„Å™„ÉÜ„Çπ„Éà„Ç∞„É©„Éï‰ΩúÊàê
            if (typeof Chart !== 'undefined') {
                try {
                    // Chart.js„ÅÆÂÖ®„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí„ÇØ„É™„Ç¢
                    Chart.helpers.each(Chart.instances, function(instance) {
                        instance.destroy();
                    });
                    
                    // recordChart„Çínull„Å´Ë®≠ÂÆö
                    recordChart = null;
                    
                    // CanvasË¶ÅÁ¥†„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà
                    const chartContainer = document.querySelector('.chart-container div');
                    chartContainer.innerHTML = '<canvas id="recordChart"></canvas>';
                    
                    const canvas = document.getElementById('recordChart');
                    recordChart = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['1Êúà', '2Êúà', '3Êúà'],
                            datasets: [{
                                label: '„ÉÜ„Çπ„Éà„Éá„Éº„Çø',
                                data: [30, 28, 26],
                                borderColor: '#2563eb',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: '„ÉÜ„Çπ„Éà„Ç∞„É©„Éï'
                                }
                            }
                        }
                    });
                    
                    document.querySelector('.chart-container').style.display = 'block';
                    debug += '‚úÖ „ÉÜ„Çπ„Éà„Ç∞„É©„Éï‰ΩúÊàêÊàêÂäüÔºÅ<br>';
                } catch (error) {
                    debug += `‚ùå „Ç∞„É©„Éï‰ΩúÊàê„Ç®„É©„Éº: ${error.message}<br>`;
                }
            }
            
            debugContent.innerHTML = debug;
        }

        // ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„ÇíChart.js„Éá„Éº„Çø„Çª„ÉÉ„Éà„Å®„Åó„Å¶ÂèñÂæó
        async function getTargetLinesForChart(stroke, distance, poolType, existingRecords) {
            try {
                if (!window.targetManager) {
                    return [];
                }
                
                const targetLines = window.targetManager.getTargetLines(stroke, distance, poolType);
                
                if (!targetLines || targetLines.length === 0) {
                    return [];
                }
                
                // Êó¢Â≠ò„ÅÆË®òÈå≤„Éá„Éº„Çø„Åã„ÇâÊó•‰ªòÁØÑÂõ≤„ÇíÂèñÂæó
                let minDate = '2020-01-01';
                let maxDate = '2030-12-31';
                
                if (existingRecords && existingRecords.length > 0) {
                    const dates = existingRecords.map(r => new Date(r.Êó•‰ªò)).sort((a, b) => a - b);
                    minDate = new Date(dates[0].getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; // 30Êó•Ââç
                    maxDate = new Date(dates[dates.length - 1].getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; // 30Êó•Âæå
                }
                
                console.log('Target line date range:', { minDate, maxDate });
                
                // ÂêÑÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„ÇíÊ∞¥Âπ≥Á∑ö„Éá„Éº„Çø„Çª„ÉÉ„Éà„Å®„Åó„Å¶‰ΩúÊàê
                const targetDatasets = targetLines.map((target, index) => {
                    // „Ç∞„É©„Éï„ÅÆÂÖ®ÂπÖ„Å´„Çè„Åü„ÇãÊ∞¥Âπ≥Á∑ö„Éá„Éº„Çø
                    const horizontalLineData = [
                        { x: minDate, y: target.time },
                        { x: maxDate, y: target.time }
                    ];
                    
                    const dataset = {
                        label: `${target.label} (${target.time}s)`,
                        data: horizontalLineData,
                        type: 'line',
                        borderColor: target.color,
                        backgroundColor: 'transparent',
                        borderWidth: target.style.width,
                        borderDash: target.style.lineStyle === 'dashed' ? [8, 4] : 
                                   target.style.lineStyle === 'dotted' ? [3, 3] : [],
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        tension: 0,
                        showLine: true,
                        order: -1, // ÁõÆÊ®ôÁ∑ö„ÇíÂâçÈù¢„Å´Ë°®Á§∫
                        yAxisID: 'y', // YËª∏„ÇíÊòéÁ§∫ÁöÑ„Å´ÊåáÂÆö
                        isTargetLine: true // ÁõÆÊ®ôÁ∑ö„ÅÆË≠òÂà•Áî®
                    };
                    
                    console.log(`Target dataset ${index}:`, dataset);
                    return dataset;
                });
                
                console.log('Target datasets created:', targetDatasets.length);
                return targetDatasets;
                
            } catch (error) {
                console.error('ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„Éá„Éº„Çø„Çª„ÉÉ„Éà‰ΩúÊàê„Ç®„É©„Éº:', error);
                return [];
            }
        }
        
        // ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„ÅÆÂá°‰æã„Çí‰ΩúÊàê
        async function createTargetLegend(stroke, distance, poolType) {
            try {
                if (!window.targetManager) {
                    return;
                }
                
                const targetLines = window.targetManager.getTargetLines(stroke, distance, poolType);
                const legendContent = document.getElementById('target-legend-content');
                
                if (!targetLines || targetLines.length === 0) {
                    legendContent.innerHTML = '<div style="color: #6b7280;">ÁõÆÊ®ô„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    return;
                }
                
                legendContent.innerHTML = '';
                
                targetLines.forEach(target => {
                    const legendItem = document.createElement('div');
                    legendItem.style.cssText = 'display: flex; align-items: center; padding: 4px;';
                    
                    // Á∑ö„ÅÆ„Çπ„Çø„Ç§„É´„ÇíË°®Áèæ„Åô„ÇãSVG
                    const lineStyle = target.style.lineStyle === 'dashed' ? 'stroke-dasharray="8,4"' : 
                                    target.style.lineStyle === 'dotted' ? 'stroke-dasharray="3,3"' : '';
                    
                    legendItem.innerHTML = `
                        <svg width="30" height="12" style="margin-right: 8px;">
                            <line x1="0" y1="6" x2="30" y2="6" 
                                  stroke="${target.color}" 
                                  stroke-width="${target.style.width}" 
                                  ${lineStyle} />
                        </svg>
                        <span style="color: #374151; font-weight: 500;">${target.label}: ${target.time}s</span>
                    `;
                    
                    legendContent.appendChild(legendItem);
                });
                
            } catch (error) {
                console.error('Âá°‰æã‰ΩúÊàê„Ç®„É©„Éº:', error);
            }
        }

        // „Ç∞„É©„ÉïÊõ¥Êñ∞Èñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.updateChart = async function() {
            try {
                // „Åæ„ÅöÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Ç∞„É©„Éï„Çí„ÇØ„É™„Ç¢
                document.querySelector('.chart-container').style.display = 'none';
                document.getElementById('advice-section').style.display = 'none';
                document.getElementById('advice-content').innerHTML = '';
                document.getElementById('debug-info').style.display = 'none';

                const stroke = document.getElementById('chart-stroke').value;
                const distance = document.getElementById('chart-distance').value;
                const pool = document.getElementById('chart-pool').value;

                if (!stroke || !distance) {
                    document.querySelector('.chart-container').style.display = 'none';
                    document.getElementById('advice-section').style.display = 'none';
                    // ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                    document.getElementById('advice-content').innerHTML = '';
                    return;
                }

                // „Éá„Éº„Çø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                let filteredRecords = records.filter(record => 
                    record.Á®ÆÁõÆ === stroke && record.Ë∑ùÈõ¢ === distance
                );

                if (pool) {
                    filteredRecords = filteredRecords.filter(record => record.„Éó„Éº„É´ === pool);
                }

                // „Éó„Éº„É´ÈÅ∏Êäû„Å´Âøú„Åò„Å¶ÂØæÊØî„Éá„Éº„Çø„ÇíÂèñÂæó
                let compareRecords = [];
                if (pool === 'Èï∑Ê∞¥Ë∑Ø') {
                    // Èï∑Ê∞¥Ë∑ØÈÅ∏ÊäûÊôÇ„ÅØÁü≠Ê∞¥Ë∑Ø„Éá„Éº„Çø„ÇÇÂèñÂæó
                    compareRecords = records.filter(record => 
                        record.Á®ÆÁõÆ === stroke && record.Ë∑ùÈõ¢ === distance && record.„Éó„Éº„É´ === 'Áü≠Ê∞¥Ë∑Ø'
                    );
                } else if (pool === 'Áü≠Ê∞¥Ë∑Ø') {
                    // Áü≠Ê∞¥Ë∑ØÈÅ∏ÊäûÊôÇ„ÅØÈï∑Ê∞¥Ë∑Ø„Éá„Éº„Çø„ÇÇÂèñÂæó
                    compareRecords = records.filter(record => 
                        record.Á®ÆÁõÆ === stroke && record.Ë∑ùÈõ¢ === distance && record.„Éó„Éº„É´ === 'Èï∑Ê∞¥Ë∑Ø'
                    );
                }

                if (filteredRecords.length === 0 && compareRecords.length === 0) {
                    document.querySelector('.chart-container').style.display = 'none';
                    document.getElementById('advice-section').style.display = 'none';
                    // ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                    document.getElementById('advice-content').innerHTML = '';
                    
                    // „Éá„Éº„Çø„Å™„Åó„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `‚ùå ${stroke} ${distance}m ${pool || '„Åô„Åπ„Å¶'} „ÅÆ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì<br>„Éï„Ç£„É´„ÇøÂæå: ${filteredRecords.length}‰ª∂, ÊØîËºÉ: ${compareRecords.length}‰ª∂`;
                    return;
                }

                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÈö†„Åô
                document.getElementById('debug-info').style.display = 'none';

                // „Éá„Éº„Çø„ÇΩ„Éº„ÉàÔºàÊó•‰ªòÈ†ÜÔºâ
                filteredRecords.sort((a, b) => new Date(a.Êó•‰ªò) - new Date(b.Êó•‰ªò));
                compareRecords.sort((a, b) => new Date(a.Êó•‰ªò) - new Date(b.Êó•‰ªò));

                // „Ç∞„É©„Éï„Éá„Éº„ÇøÊ∫ñÂÇô
                const datasets = [];

                if (filteredRecords.length > 0) {
                    datasets.push({
                        label: `${stroke} ${distance}m (${pool || 'All'})`,
                        data: filteredRecords.map(record => ({
                            x: record.Êó•‰ªò,
                            y: parseTimeToSeconds(record.„Çø„Ç§„É†)
                        })),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: false,
                        tension: 0.1
                    });
                }

                if (compareRecords.length > 0) {
                    const compareLabel = pool === 'Èï∑Ê∞¥Ë∑Ø' ? 'Áü≠Ê∞¥Ë∑ØÂèÇËÄÉ' : 'Èï∑Ê∞¥Ë∑ØÂèÇËÄÉ';
                    datasets.push({
                        label: `${stroke} ${distance}m (${compareLabel})`,
                        data: compareRecords.map(record => ({
                            x: record.Êó•‰ªò,
                            y: parseTimeToSeconds(record.„Çø„Ç§„É†)
                        })),
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5]
                    });
                }

                // ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„Çí„Éá„Éº„Çø„Çª„ÉÉ„Éà„Å®„Åó„Å¶ËøΩÂä†
                const targetLines = await getTargetLinesForChart(stroke, distance, pool, filteredRecords);
                datasets.push(...targetLines);
                
                console.log('Final datasets count:', datasets.length);
                console.log('Target datasets:', targetLines.length);
                console.log('All datasets details:');
                datasets.forEach((dataset, index) => {
                    console.log(`  Dataset ${index}: ${dataset.label}, points: ${dataset.data?.length || 0}, type: ${dataset.type || 'line'}`);
                    if (dataset.data && dataset.data.length > 0) {
                        console.log(`    Sample data:`, dataset.data.slice(0, 2));
                    }
                });
                
                // „Ç∞„É©„Éï‰ΩúÊàê
                const success = createChart(datasets);
                
                if (success) {
                    // ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„ÅÆÂá°‰æã„Çí‰ΩúÊàê
                    createTargetLegend(stroke, distance, pool);

                    // „Ç¢„Éâ„Éê„Ç§„ÇπÁîüÊàê
                    generateAdvice(stroke, distance, pool, filteredRecords);

                    // Ë°®Á§∫
                    document.querySelector('.chart-container').style.display = 'block';
                    document.getElementById('advice-section').style.display = 'block';
                    
                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `‚úÖ „Ç∞„É©„Éï‰ΩúÊàêÊàêÂäüÔºÅ „Éá„Éº„Çø: ${filteredRecords.length}‰ª∂`;
                    setTimeout(() => {
                        debugDiv.style.display = 'none';
                    }, 3000);
                } else {
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `‚ùå „Ç∞„É©„Éï‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`;
                }
                
            } catch (error) {
                console.error('updateChart „Ç®„É©„Éº:', error);
                const debugDiv = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugDiv.style.display = 'block';
                debugContent.innerHTML = `‚ùå „Ç∞„É©„ÉïÊõ¥Êñ∞„Ç®„É©„Éº: ${error.message}`;
            }
        }

        function createChart(datasets) {
            try {
                console.log('createChartÈñãÂßã, datasets:', datasets);
                
                // Chart.js„ÅÆÂÖ®„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí„ÇØ„É™„Ç¢
                if (Chart.instances) {
                    Chart.helpers.each(Chart.instances, function(instance) {
                        instance.destroy();
                    });
                }
                
                // recordChart„Çínull„Å´Ë®≠ÂÆö
                recordChart = null;

                // CanvasË¶ÅÁ¥†„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà
                const chartContainer = document.querySelector('.chart-container div');
                if (!chartContainer) {
                    console.error('Chart container not found');
                    return false;
                }
                
                chartContainer.innerHTML = '<canvas id="recordChart"></canvas>';
                
                const canvas = document.getElementById('recordChart');
                if (!canvas) {
                    console.error('Canvas element not found');
                    return false;
                }
                
                const ctx = canvas.getContext('2d');
                console.log('CanvasÊ∫ñÂÇôÂÆå‰∫Ü');

                // Chart.js timeËª∏„Å´ÂØæÂøú„Åô„Çã„Éá„Éº„Çø„Çª„ÉÉ„ÉàÂá¶ÁêÜ
                console.log('Input datasets for Chart.js:', datasets);
                
                const processedDatasets = datasets.map(dataset => {
                    console.log('Processing dataset:', dataset.label, 'data points:', dataset.data.length);
                    
                    // timeËª∏Áî®„ÅÆ„Éá„Éº„ÇøÂΩ¢Âºè„Å´Â§âÊèõ
                    const processedData = dataset.data.map(point => ({
                        x: point.x, // Êó•‰ªòÊñáÂ≠óÂàó„Åæ„Åü„ÅØDate„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                        y: point.y  // „Çø„Ç§„É†ÂÄ§
                    }));
                    
                    console.log('Processed data points:', processedData);
                    
                    return {
                        ...dataset,
                        data: processedData
                    };
                });
                
                console.log('Final processed datasets for Chart.js creation:');
                processedDatasets.forEach((dataset, index) => {
                    console.log(`  Chart Dataset ${index}:`, {
                        label: dataset.label,
                        type: dataset.type,
                        dataPoints: dataset.data.length,
                        borderColor: dataset.borderColor,
                        borderWidth: dataset.borderWidth,
                        borderDash: dataset.borderDash,
                        sampleData: dataset.data.slice(0, 2)
                    });
                });
                
                recordChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: processedDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Ë®òÈå≤Êé®Áßª„Ç∞„É©„Éï'
                            },
                            legend: {
                                display: true,
                                labels: {
                                    filter: function(legendItem, chartData) {
                                        // ÁõÆÊ®ôÁ∑ö„ÇíÂá°‰æã„Åã„ÇâÈô§Â§ñ
                                        console.log('Legend filter called:', legendItem.text);
                                        const isTarget = legendItem.text.includes('ÂÖ®‰∏≠') || 
                                                       legendItem.text.includes('JO') ||
                                                       legendItem.text.includes('ÂÑ™Âãù') ||
                                                       legendItem.text.includes('Ê±∫Âãù') ||
                                                       legendItem.text.includes('Ê®ôÊ∫ñ');
                                        console.log('Is target line:', isTarget);
                                        return !isTarget;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {}
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    parser: 'yyyy-MM-dd',
                                    displayFormats: {
                                        day: 'MM/dd',
                                        month: 'yyyy/MM'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Êó•‰ªò'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '„Çø„Ç§„É†'
                                },
                                reverse: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatSecondsToTime(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('Chart‰ΩúÊàêÊàêÂäü');
                
                return true;
            } catch (error) {
                console.error('„Ç∞„É©„Éï‰ΩúÊàê„Ç®„É©„Éº:', error);
                const debugDiv = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugDiv.style.display = 'block';
                debugContent.innerHTML = `‚ùå „Ç∞„É©„Éï‰ΩúÊàê„Ç®„É©„Éº: ${error.message}<br>Ë©≥Á¥∞: ${error.stack}`;
                return false;
            }
        }

        // ÊúÄËøë„ÅÆË®òÈå≤„ÇíÂàÜÊûê„Åô„ÇãÈñ¢Êï∞
        function analyzeRecentRecords(records) {
            if (records.length < 2) {
                return {
                    trend: 'initial',
                    message: 'Ë®òÈå≤„Åå„Çπ„Çø„Éº„Éà„Åó„Åü„Å∞„Åã„ÇäÔºÅ„Åì„Çå„Åã„Çâ„ÅÆÊàêÈï∑„ÅåÊ•Ω„Åó„Åø„Åß„Åô„Å≠ÔºÅ',
                    detail: 'ÊúÄÂàù„ÅÆ‰∏ÄÊ≠©„ÅåË∏è„ÅøÂá∫„Åõ„Åæ„Åó„Åü„ÄÇÁ∂ôÁ∂ö„ÅØÂäõ„Å™„Çä„ÄÅ„Åå„Çì„Å∞„Çä„Åæ„Åó„Çá„ÅÜÔºÅ'
                };
            }

            // Áõ¥Ëøë5Âõû„ÅÆË®òÈå≤„ÇíÂèñÂæóÔºàÊó•‰ªòÈ†Ü„Å´„ÇΩ„Éº„ÉàÊ∏à„ÅøÔºâ
            const recentCount = Math.min(5, records.length);
            const recentRecords = records.slice(-recentCount);
            const times = recentRecords.map(r => parseTimeToSeconds(r.„Çø„Ç§„É†));
            
            // ÂÇæÂêëÂàÜÊûê
            let improvements = 0;
            let stable = 0;
            let challenges = 0;
            
            for (let i = 1; i < times.length; i++) {
                const diff = times[i-1] - times[i]; // ÂâçÂõû„Å®„ÅÆÂ∑ÆÔºàÊ≠£„Å™„ÇâÂêë‰∏äÔºâ
                if (diff > 0.1) improvements++;
                else if (Math.abs(diff) <= 0.1) stable++;
                else challenges++;
            }
            
            // ÊúÄÊñ∞3Âõû„ÅÆÂπ≥Âùá„Å®Ââç„ÅÆË®òÈå≤„ÅÆÊØîËºÉ
            const latest3 = times.slice(-3);
            const earlier3 = times.slice(-6, -3);
            const latest3Avg = latest3.reduce((a, b) => a + b, 0) / latest3.length;
            const earlier3Avg = earlier3.length > 0 ? earlier3.reduce((a, b) => a + b, 0) / earlier3.length : latest3Avg;
            
            // „Éô„Çπ„Éà„Çø„Ç§„É†„Åã„Çâ„ÅÆ‰ΩçÁΩÆ
            const bestTime = Math.min(...times);
            const latestTime = times[times.length - 1];
            const gapFromBest = latestTime - bestTime;
            
            // „Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
            let trend, message, detail;
            
            if (improvements >= challenges && latest3Avg <= earlier3Avg) {
                trend = 'improving';
                const messages = [
                    'Á¥†Êô¥„Çâ„Åó„ÅÑÂêë‰∏äÂÇæÂêë„Åß„ÅôÔºÅÁ∂ôÁ∂ö„Åó„ÅüÂä™Âäõ„ÅÆÊàêÊûú„ÅåÁèæ„Çå„Å¶„ÅÑ„Åæ„ÅôÔºÅ',
                    'ÁùÄÂÆü„Å´„Çø„Ç§„É†„ÅåÁ∏Æ„Åæ„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ„Åì„ÅÆË™øÂ≠ê„ÅßÊõ¥„Å™„ÇãÈ´ò„Åø„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜÔºÅ',
                    'ÊàêÈï∑„Ç´„Éº„Éñ„ÅåÂè≥ËÇ©‰∏ä„Åå„Çä„Åß„ÅôÔºÅÁ∑¥Áøí„ÅÆË≥™„ÅåÂêë‰∏ä„Åó„Å¶„ÅÑ„ÇãË®ºÊã†„Åß„Åô„Å≠ÔºÅ'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = gapFromBest < 1 ? 
                    '„Éô„Çπ„Éà„Çø„Ç§„É†„Å´Ëø´„ÇãÁ¥†Êô¥„Çâ„Åó„ÅÑ„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥„Åß„ÅôÔºÅ' : 
                    `„Éô„Çπ„Éà„Çø„Ç§„É†„Åæ„Åß${gapFromBest.toFixed(2)}Áßí„ÄÇ„ÇÇ„ÅÜ‰∏ÄÊäº„Åó„Åß„Éñ„É¨„Ç§„ÇØ„Çπ„É´„Éº„Åß„ÅôÔºÅ`;
            } else if (stable > improvements && stable > challenges) {
                trend = 'stable';
                const messages = [
                    'ÂÆâÂÆö„Åó„Åü„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇíÁ∂≠ÊåÅ„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ„Åì„ÅÆÂÆâÂÆöÊÑü„ÅåÊ¨°„ÅÆÈ£õË∫ç„ÅÆÂü∫Áõ§„Åß„ÅôÔºÅ',
                    '„Ç≥„É≥„Çπ„Çø„É≥„Éà„Å´ËâØ„ÅÑ„Çø„Ç§„É†„Çí„Ç≠„Éº„ÉóÔºÅÊäÄË°ìÁöÑ„Å™ÊàêÁÜü„ÇíÊÑü„Åò„Åæ„ÅôÔºÅ',
                    '‰∏ÄÂÆö„É¨„Éô„É´„ÅÆÂÆüÂäõ„Çí„Åó„Å£„Åã„ÇäÁ∂≠ÊåÅÔºÅ„Åì„ÅÆÂÆâÂÆöÊÄß„Åì„Åù„ÅåÁ´∂ÊäÄËÄÖ„ÅÆË®º„Åß„ÅôÔºÅ'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = '„Åì„ÅÆÂÆâÂÆöÊÑü„Åã„Çâ‰∏ÄÊ∞ó„Å´„Éñ„É¨„Ç§„ÇØ„Çπ„É´„Éº„Åô„ÇãÁû¨Èñì„ÅåÂøÖ„ÅöÊù•„Åæ„ÅôÔºÅ';
            } else {
                trend = 'challenging';
                const messages = [
                    'Êñ∞„Åó„ÅÑ„ÉÅ„É£„É¨„É≥„Ç∏„Å´Âèñ„ÇäÁµÑ„Çì„Åß„ÅÑ„ÇãË®ºÊã†„Åß„ÅôÔºÅÊåëÊà¶„ÅØÊàêÈï∑„ÅÆÊ∫ê„Åß„ÅôÔºÅ',
                    '„Çà„ÇäÈ´ò„ÅÑÁõÆÊ®ô„Å´Âêë„Åã„Å£„Å¶„ÅÑ„ÇãÈÅéÁ®ã„Åß„Åô„Å≠ÔºÅ„Åì„ÅÆÁµåÈ®ì„ÅåÂøÖ„ÅöÊ¥ª„Åã„Åï„Çå„Åæ„ÅôÔºÅ',
                    'Êñ∞„Åó„ÅÑÊäÄË°ì„ÇÑÊà¶Áï•„ÇíË©¶Ë°åÈåØË™§‰∏≠ÔºÅ„Åì„ÅÆÁ©çÊ•µÊÄß„ÅåÊàêÂäü„Å∏„ÅÆÈçµ„Åß„ÅôÔºÅ'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = '„ÉÅ„É£„É¨„É≥„Ç∏„ÅÆÂÖà„Å´„ÅØÂøÖ„ÅöÂ§ß„Åç„Å™ÊàêÈï∑„ÅåÂæÖ„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ';
            }
            
            return { trend, message, detail };
        }

        // ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„Å®„ÅÆÊØîËºÉÂàÜÊûê
        function analyzeTargetComparison(stroke, distance, pool, bestTime) {
            if (!window.targetManager) {
                return { hasTarget: false };
            }

            const targetLines = window.targetManager.getTargetLines(stroke, distance, pool);
            if (!targetLines || targetLines.length === 0) {
                return { hasTarget: false };
            }

            // ÁõÆÊ®ô„Çí„Çø„Ç§„É†È†Ü„Å´„ÇΩ„Éº„ÉàÔºàÈÄü„ÅÑÈ†ÜÔºâ
            const sortedTargets = targetLines.sort((a, b) => a.time - b.time);
            
            let nextTarget = null;
            let achievedTargets = [];
            
            // ÈÅîÊàêÊ∏à„ÅøÁõÆÊ®ô„Å®Ê¨°„ÅÆÁõÆÊ®ô„ÇíÂà§ÂÆö
            for (const target of sortedTargets) {
                if (bestTime <= target.time) {
                    achievedTargets.push(target);
                } else if (!nextTarget) {
                    nextTarget = target;
                }
            }
            
            return {
                hasTarget: true,
                nextTarget: nextTarget,
                achievedTargets: achievedTargets,
                allTargets: sortedTargets,
                bestTime: bestTime
            };
        }

        // ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„Å´Âü∫„Å•„ÅèÂä±„Åæ„Åó„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
        function generateTargetMotivationMessage(targetAnalysis) {
            const { nextTarget, achievedTargets, bestTime } = targetAnalysis;
            
            let message = '';
            
            // ÈÅîÊàêÊ∏à„Åø„ÅÆÁõÆÊ®ô„Åå„ÅÇ„ÇãÂ†¥Âêà
            if (achievedTargets.length > 0) {
                const topAchievement = achievedTargets[0]; // ÊúÄ„ÇÇÊó©„ÅÑÈÅîÊàêÊ∏à„ÅøÁõÆÊ®ô
                message += `<p style="color: #059669; font-weight: 600;">üèÜ ${topAchievement.label} ÈÅîÊàêÊ∏à„ÅøÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÂÆüÂäõ„Åß„ÅôÔºÅ</p>`;
            }
            
            // Ê¨°„ÅÆÁõÆÊ®ô„Åå„ÅÇ„ÇãÂ†¥Âêà
            if (nextTarget) {
                const timeGap = nextTarget.time - bestTime;
                const timeGapStr = timeGap.toFixed(2);
                
                message += `<p style="color: #0891b2; font-weight: 600;">üéØ Ê¨°„ÅÆÁõÆÊ®ô: ${nextTarget.label}</p>`;
                message += `<p style="color: #374151; font-size: 0.9em;">„ÅÇ„Å®${timeGapStr}Áßí„ÅÆÁü≠Á∏Æ„ÅßÈÅîÊàê„Åß„ÅôÔºÅ</p>`;
                
                // ÁõÆÊ®ô„É¨„Éô„É´Âà•„ÅÆÂÖ∑‰ΩìÁöÑ„Å™Âä±„Åæ„Åó„É°„ÉÉ„Çª„Éº„Ç∏
                if (nextTarget.label.includes('Ê®ôÊ∫ñ')) {
                    message += `<p style="color: #16a34a; font-size: 0.85em;">üí™ Ê®ôÊ∫ñË®òÈå≤Á™ÅÁ†¥„Åæ„Åß„ÅÇ„Å®Â∞ë„ÅóÔºÅÂü∫Á§éÁ∑¥Áøí„ÇíÂ§ßÂàá„Å´„ÄÅ‰∏ÄÊ≠©‰∏ÄÊ≠©ÈÄ≤„Çì„Åß„ÅÑ„Åì„ÅÜÔºÅ</p>`;
                } else if (nextTarget.label.includes('Ê±∫Âãù')) {
                    message += `<p style="color: #dc2626; font-size: 0.85em;">üî• Ê±∫ÂãùÈÄ≤Âá∫„É¨„Éô„É´ÔºÅ„Åì„Åì„Åã„Çâ„ÅåÊú¨ÂΩì„ÅÆÂãùË≤†„ÄÇÁ¥∞„Åã„ÅÑÊäÄË°ì„ÅÆÂêë‰∏ä„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ</p>`;
                } else if (nextTarget.label.includes('ÂÑ™Âãù')) {
                    message += `<p style="color: #7c2d12; font-size: 0.85em;">üëë ÂÑ™Âãù„É¨„Éô„É´ÔºÅ„Éà„ÉÉ„ÉóÈÅ∏Êâã„ÅÆ‰ª≤ÈñìÂÖ•„Çä„ÄÇ„Åï„Çâ„Å™„ÇãÈ´ò„Åø„ÇíÁõÆÊåá„Åó„Å¶ÊåëÊà¶„ÅóÁ∂ö„Åë„Çà„ÅÜÔºÅ</p>`;
                }
                
                // ÊôÇÈñìÂ∑Æ„Å´Âü∫„Å•„ÅèÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ
                if (timeGap <= 1.0) {
                    message += `<p style="color: #ea580c; font-size: 0.8em;">üöÄ „ÅÇ„Å®1Áßí‰ª•ÂÜÖÔºÅ„Çπ„Çø„Éº„Éà„ÇÑ„Çø„Éº„É≥„ÅÆÊäÄË°ìÂêë‰∏ä„ÅßÈÅîÊàêÂèØËÉΩ„Åß„ÅôÔºÅ</p>`;
                } else if (timeGap <= 3.0) {
                    message += `<p style="color: #0369a1; font-size: 0.8em;">‚ö° „ÅÇ„Å®Êï∞ÁßíÔºÅ„Éï„Ç©„Éº„É†ÊîπÂñÑ„Å®„Éö„Éº„ÇπÈÖçÂàÜ„ÅßÂøÖ„ÅöÂ±ä„Åç„Åæ„ÅôÔºÅ</p>`;
                } else {
                    message += `<p style="color: #059669; font-size: 0.8em;">üìà Á∂ôÁ∂öÁöÑ„Å™Á∑¥Áøí„ÅßÁ¢∫ÂÆü„Å´Âêë‰∏ä„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁõÆÊ®ôÈÅîÊàê„Åæ„Åß‰∏ÄÁ∑í„Å´È†ëÂºµ„Çç„ÅÜÔºÅ</p>`;
                }
            } else {
                // ÂÖ®„Å¶„ÅÆÁõÆÊ®ô„ÇíÈÅîÊàêÊ∏à„Åø„ÅÆÂ†¥Âêà
                message += `<p style="color: #dc2626; font-weight: 600;">üåü ÂÖ®„Å¶„ÅÆÁõÆÊ®ôÂü∫Ê∫ñ„Çí„ÇØ„É™„Ç¢ÔºÅ„Éà„ÉÉ„Éó„É¨„Éô„É´„ÅÆÂÆüÂäõ„Åß„ÅôÔºÅ</p>`;
                message += `<p style="color: #374151; font-size: 0.9em;">„Åï„Çâ„Å™„ÇãËá™Â∑±„Éô„Çπ„ÉàÊõ¥Êñ∞„ÇíÁõÆÊåá„Åó„Å¶„ÄÅÈôêÁïå„Å´ÊåëÊà¶„ÅóÁ∂ö„Åë„Çà„ÅÜÔºÅ</p>`;
            }
            
            return message;
        }

        function generateAdvice(stroke, distance, pool, records) {
            if (records.length === 0) return;

            const bestTime = Math.min(...records.map(r => parseTimeToSeconds(r.„Çø„Ç§„É†)));
            const latestTime = parseTimeToSeconds(records[records.length - 1].„Çø„Ç§„É†);
            const improvement = records.length > 1 ? 
                parseTimeToSeconds(records[0].„Çø„Ç§„É†) - parseTimeToSeconds(records[records.length - 1].„Çø„Ç§„É†) : 0;

            // ÊúÄËøë„ÅÆË®òÈå≤ÂàÜÊûê
            const recentAnalysis = analyzeRecentRecords(records);
            
            // ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„Å®„ÅÆÊØîËºÉÂàÜÊûê
            const targetAnalysis = analyzeTargetComparison(stroke, distance, pool, bestTime);

            let advice = `<div style="line-height: 1.6;">`;
            
            // Á®ÆÁõÆÂà•„Ç¢„Éâ„Éê„Ç§„Çπ
            const strokeAdvice = {
                '„Éê„Çø„Éï„É©„Ç§': {
                    tips: ['„Çπ„Éà„É™„Éº„É†„É©„Ç§„É≥„ÇíÊÑèË≠ò„Åó„Å¶ÔºÅ', '„Ç≠„ÉÉ„ÇØ„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åå„Éù„Ç§„É≥„ÉàÔºÅ', 'ËÇ©„ÅÆÊüîËªüÊÄß„ÇíÈ´ò„ÇÅ„Çà„ÅÜÔºÅ'],
                    motivation: 'Áæé„Åó„ÅÑ„Éê„Çø„Éï„É©„Ç§„ÅßÊ∞¥Èù¢„ÇíÂà∂Ë¶á„Åó„Çà„ÅÜÔºÅü¶ã'
                },
                'Ëá™Áî±ÂΩ¢': {
                    tips: ['„Çπ„Éà„É≠„Éº„ÇØÊï∞„Çí„Ç´„Ç¶„É≥„Éà„Åó„Å¶„Åø„Çà„ÅÜÔºÅ', '„Ç≠„É£„ÉÉ„ÉÅ„Çí„Åó„Å£„Åã„Çä„Å®ÔºÅ', '„Çø„Éº„É≥„ÅÆ„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ'],
                    motivation: '„Çπ„Éî„Éº„Éâ„ÅÆÁéãÊßò„ÄÅËá™Áî±ÂΩ¢„ÅßÈ¢®„ÅÆ„Çà„ÅÜ„Å´Ê≥≥„Åî„ÅÜÔºÅüåä'
                },
                'ËÉåÊ≥≥„Åé': {
                    tips: ['‰Ωì„ÅÆËª∏„Çí„Åæ„Å£„Åô„Åê„Å´ÔºÅ', '„Éï„É©„ÉÉ„Ç∞„Åã„Çâ„ÅÆË∑ùÈõ¢ÊÑü„ÇíÊé¥„ÇÇ„ÅÜÔºÅ', 'ËÖ∞„ÅÆ‰ΩçÁΩÆ„ÇíÈ´ò„Åè‰øù„Å®„ÅÜÔºÅ'],
                    motivation: 'Á©∫„ÇíË¶ã„Å™„Åå„Çâ„ÄÅÊúÄÈ´ò„ÅÆ„Çø„Ç§„É†„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ‚òÅÔ∏è'
                },
                'Âπ≥Ê≥≥„Åé': {
                    tips: ['‰∏ÄÊéª„Åç‰∏ÄËπ¥„Çä„ÇíÂ§ßÂàá„Å´ÔºÅ', '„Çπ„Éà„É™„Éº„É†„É©„Ç§„É≥„ÅÆÊôÇÈñì„ÇíÈï∑„ÅèÔºÅ', '„Çø„Ç§„Éü„É≥„Ç∞„ÅåÂëΩÔºÅ'],
                    motivation: 'ÊäÄË°ì„ÅÆÂπ≥Ê≥≥„Åé„ÄÅÁæé„Åó„ÅÑ„Éï„Ç©„Éº„É†„ÅßÂãùË≤†ÔºÅüê∏'
                },
                'ÂÄã‰∫∫„É°„Éâ„É¨„Éº': {
                    tips: ['ÂêÑÁ®ÆÁõÆ„ÅÆ„Å§„Å™„Åé„ÇíÊÑèË≠ò„Åó„Å¶ÔºÅ', '„Éö„Éº„ÇπÈÖçÂàÜ„ÅåÈáçË¶ÅÔºÅ', 'ÊúÄÂæå„Åæ„ÅßË´¶„ÇÅ„Å™„ÅÑÂøÉ„ÇíÔºÅ'],
                    motivation: '„Ç™„Éº„É´„É©„Ç¶„É≥„ÉÄ„Éº„ÅÆË®º„ÄÅIM „ÅßÁ∑èÂêàÂäõ„ÇíË¶ã„Åõ„Å§„Åë„Çà„ÅÜÔºÅüèÜ'
                }
            };

            const currentStroke = strokeAdvice[stroke] || strokeAdvice['Ëá™Áî±ÂΩ¢'];
            
            advice += `<p><strong>üéØ ${stroke} ${distance}m „ÅÆÂàÜÊûêÁµêÊûú</strong></p>`;
            advice += `<p>üìà „Éô„Çπ„Éà„Çø„Ç§„É†: <span style="color: #059669; font-weight: bold;">${formatSecondsToTime(bestTime)}</span></p>`;
            advice += `<p>üìä Áõ¥Ëøë„ÅÆ„Çø„Ç§„É†: <span style="color: #2563eb; font-weight: bold;">${formatSecondsToTime(latestTime)}</span></p>`;
            
            if (improvement > 0) {
                advice += `<p>üöÄ Á∑èÂêàÂêë‰∏äÂπÖ: <span style="color: #059669; font-weight: bold;">-${improvement.toFixed(2)}Áßí</span> „Åô„Åî„ÅÑÊàêÈï∑„Åß„ÅôÔºÅ</p>`;
            } else if (improvement < 0) {
                advice += `<p>üí™ „Åæ„Å†„Åæ„Å†‰º∏„Å≥„Åó„Çç„Åå„ÅÇ„Çä„Åæ„ÅôÔºÅÊ¨°„Åì„Åù„Éô„Çπ„ÉàÊõ¥Êñ∞„Å†ÔºÅ</p>`;
            }

            // ÊúÄËøë„ÅÆË®òÈå≤ÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†
            advice += `<br><div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">`;
            advice += `<p><strong>üîç ÊúÄËøë„ÅÆË®òÈå≤ÂàÜÊûê</strong></p>`;
            advice += `<p style="color: #1e40af; font-weight: 600;">${recentAnalysis.message}</p>`;
            advice += `<p style="color: #374151; font-size: 0.95em;">${recentAnalysis.detail}</p>`;
            
            // ÁõÆÊ®ôÂü∫Ê∫ñÁ∑ö„Å´Èñ¢„Åô„ÇãÂä±„Åæ„Åó„É°„ÉÉ„Çª„Éº„Ç∏
            if (targetAnalysis.hasTarget) {
                const targetMessage = generateTargetMotivationMessage(targetAnalysis);
                if (targetMessage) {
                    advice += `<div style="margin-top: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">`;
                    advice += targetMessage;
                    advice += `</div>`;
                }
            }
            
            // Ë®òÈå≤Êï∞„Å´Âøú„Åò„ÅüËøΩÂä†„É°„ÉÉ„Çª„Éº„Ç∏
            if (records.length >= 10) {
                advice += `<p style="color: #059669; font-size: 0.9em; margin-top: 8px;">`;
                advice += `üéñÔ∏è ${records.length}Âõû„ÅÆË®òÈå≤ËìÑÁ©çÔºÅÁ∂ôÁ∂öÁöÑ„Å™Âä™Âäõ„ÅÆË≥úÁâ©„Åß„Åô„ÄÇ`;
                advice += `</p>`;
            } else if (records.length >= 5) {
                advice += `<p style="color: #0891b2; font-size: 0.9em; margin-top: 8px;">`;
                advice += `üìä ${records.length}Âõû„ÅÆË®òÈå≤„ÅßÂÇæÂêë„ÅåË¶ã„Åà„Å¶„Åç„Åæ„Åó„ÅüÔºÅ`;
                advice += `</p>`;
            }
            advice += `</div>`;
            
            advice += `<br><p><strong>üí° ${stroke}„ÅÆ„Ç≥„ÉÑ</strong></p>`;
            advice += `<p>„Éª${currentStroke.tips[Math.floor(Math.random() * currentStroke.tips.length)]}</p>`;
            
            advice += `<br><p style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 15px;">`;
            advice += `${currentStroke.motivation}`;
            advice += `</p>`;
            
            advice += `<p style="text-align: center; margin-top: 10px; color: #666; font-style: italic;">`;
            advice += `Á∑¥Áøí„ÅØË£èÂàá„Çâ„Å™„ÅÑ„ÄÇ‰ªäÊó•„ÇÇ„Éô„Çπ„Éà„ÇíÂ∞Ω„Åè„Åù„ÅÜÔºÅ‚ú®`;
            advice += `</p>`;
            
            advice += `</div>`;

            document.getElementById('advice-content').innerHTML = advice;
        }

        // „Éï„Ç£„É´„Çø„Éº„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂàùÊúüÂåñ
        function populateFilters() {
            // „Éó„Éº„É´„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
            const poolSelect = document.getElementById('filter-pool');
            const pools = [...new Set(records.map(r => r.„Éó„Éº„É´))].filter(p => p).sort();
            pools.forEach(pool => {
                const option = document.createElement('option');
                option.value = pool;
                option.textContent = pool;
                poolSelect.appendChild(option);
            });

            // Â§ß‰ºöÂêç„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
            const competitionSelect = document.getElementById('filter-competition');
            const competitions = [...new Set(records.map(r => r.Â§ß‰ºöÂêç))].filter(c => c).sort();
            competitions.forEach(competition => {
                const option = document.createElement('option');
                option.value = competition;
                option.textContent = competition;
                competitionSelect.appendChild(option);
            });

            // Ë®òÈå≤ËøΩÂä†„Éï„Ç©„Éº„É†„ÅÆÂ§ß‰ºöÂêç„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇíÂàùÊúüÂåñ
            const addCompetitionSelect = document.getElementById('competition');
            // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥Ôºà„ÄåÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Äç‰ª•Â§ñÔºâ„Çí„ÇØ„É™„Ç¢
            while (addCompetitionSelect.children.length > 1) {
                addCompetitionSelect.removeChild(addCompetitionSelect.lastChild);
            }
            competitions.forEach(competition => {
                const option = document.createElement('option');
                option.value = competition;
                option.textContent = competition;
                addCompetitionSelect.appendChild(option);
            });
        }

        // È†Ü‰ΩçÈÅ∏Êäû„ÅÆÂàá„ÇäÊõø„ÅàÊ©üËÉΩÔºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºâ
        window.toggleCustomRank = function() {
            const rankSelect = document.getElementById('rank');
            const customRankInput = document.getElementById('custom-rank');
            
            if (rankSelect.value === 'custom') {
                customRankInput.style.display = 'block';
                customRankInput.required = true;
            } else {
                customRankInput.style.display = 'none';
                customRankInput.required = false;
                customRankInput.value = '';
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„Å´„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // „É¨„Ç≥„Éº„Éâ„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„ÅüÂæå„Å´„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
            setTimeout(populateFilters, 1000);
        });
    </script>
</body>
</html>