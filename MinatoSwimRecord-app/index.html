<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="ç«¶æ³³è¨˜éŒ²ç®¡ç†ãƒ»åˆ†æãƒ»ç›®æ¨™è¨­å®šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸŠâ€â™‚ï¸ MinatoSwimRecord - ç«¶æ³³è¨˜éŒ²ç®¡ç†ã‚¢ãƒ—ãƒª - ğŸš€FIXED-1415ğŸš€</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .header h1 {
            color: #2563eb;
            font-size: 2.2em;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 1em;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
            touch-action: manipulation;
        }

        .nav-tab.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
            min-height: 48px;
            touch-action: manipulation;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            padding: 12px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            touch-action: manipulation;
            min-height: 48px;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            padding: 8px 12px;
            font-size: 14px;
            min-height: 36px;
        }

        .btn-danger:hover {
            background: #b91c1c;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .record-table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        .record-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .record-table th,
        .record-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .record-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        .record-table tr:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .stat-card p {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 33% { content: '.'; }
            34%, 66% { content: '..'; }
            67%, 100% { content: '...'; }
        }

        .install-prompt {
            background: rgba(37, 99, 235, 0.1);
            border: 2px solid #2563eb;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .install-prompt.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .nav-tabs {
                padding: 3px;
            }
            
            .nav-tab {
                padding: 10px 6px;
                font-size: 0.8em;
            }
            
            .content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card h3 {
                font-size: 1.6em;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .record-table th,
            .record-table td {
                padding: 8px 4px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .nav-tab {
                font-size: 0.75em;
                padding: 8px 4px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="install-prompt" id="install-prompt">
        <p>ğŸ“± ã“ã®ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã§ãã¾ã™ï¼</p>
        <button class="btn" onclick="installApp()">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
        <button class="btn" onclick="hideInstallPrompt()" style="background: #6b7280; margin-left: 10px;">å¾Œã§</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸŠâ€â™‚ï¸ MinatoSwimRecord</h1>
            <p>ç«¶æ³³è¨˜éŒ²ç®¡ç†ãƒ»åˆ†æãƒ»ç›®æ¨™è¨­å®šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
            <button class="nav-tab" onclick="showTab('records')">ğŸ“ è¨˜éŒ²ä¸€è¦§</button>
            <button class="nav-tab" onclick="showTab('add-record')">â• è¨˜éŒ²è¿½åŠ </button>
            <button class="nav-tab" onclick="showTab('analysis')">ğŸ“ˆ åˆ†æ</button>
            <button class="nav-tab" onclick="showTab('data-manager')">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <h2>ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-records">-</h3>
                        <p>ç·è¨˜éŒ²æ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="best-time">-</h3>
                        <p>ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ (ãƒã‚¿ãƒ•ãƒ©ã‚¤50m)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="competitions">-</h3>
                        <p>å‚åŠ å¤§ä¼šæ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="first-places">-</h3>
                        <p>1ä½ç²å¾—æ•°</p>
                    </div>
                </div>
            </div>

            <div id="records" class="tab-content">
                <h2>ğŸ“ è¨˜éŒ²ä¸€è¦§</h2>
                <div class="form-row" style="margin-bottom: 15px;">
                    <select id="filter-stroke" onchange="filterRecords()">
                        <option value="">å…¨ç¨®ç›®</option>
                        <option value="ãƒã‚¿ãƒ•ãƒ©ã‚¤">ãƒã‚¿ãƒ•ãƒ©ã‚¤</option>
                        <option value="è‡ªç”±å½¢">è‡ªç”±å½¢</option>
                        <option value="èƒŒæ³³ã">èƒŒæ³³ã</option>
                        <option value="å¹³æ³³ã">å¹³æ³³ã</option>
                        <option value="å€‹äººãƒ¡ãƒ‰ãƒ¬ãƒ¼">å€‹äººãƒ¡ãƒ‰ãƒ¬ãƒ¼</option>
                    </select>
                    <select id="filter-distance" onchange="filterRecords()">
                        <option value="">å…¨è·é›¢</option>
                        <option value="50">50m</option>
                        <option value="100">100m</option>
                        <option value="200">200m</option>
                    </select>
                    <select id="filter-pool" onchange="filterRecords()">
                        <option value="">å…¨ãƒ—ãƒ¼ãƒ«</option>
                    </select>
                    <select id="filter-competition" onchange="filterRecords()">
                        <option value="">å…¨å¤§ä¼š</option>
                    </select>
                </div>
                <div class="record-table-container">
                    <table class="record-table" id="records-table">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>ç¨®ç›®</th>
                                <th>è·é›¢</th>
                                <th>ãƒ—ãƒ¼ãƒ«</th>
                                <th>ã‚¿ã‚¤ãƒ </th>
                                <th>å¤§ä¼šå</th>
                                <th>é †ä½</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="records-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="add-record" class="tab-content">
                <h2>â• è¨˜éŒ²è¿½åŠ </h2>
                <form id="record-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">æ—¥ä»˜</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="stroke">ç¨®ç›®</label>
                            <select id="stroke" name="stroke" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="è‡ªç”±å½¢">è‡ªç”±å½¢</option>
                                <option value="èƒŒæ³³ã">èƒŒæ³³ã</option>
                                <option value="å¹³æ³³ã">å¹³æ³³ã</option>
                                <option value="ãƒã‚¿ãƒ•ãƒ©ã‚¤">ãƒã‚¿ãƒ•ãƒ©ã‚¤</option>
                                <option value="å€‹äººãƒ¡ãƒ‰ãƒ¬ãƒ¼">å€‹äººãƒ¡ãƒ‰ãƒ¬ãƒ¼</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="distance">è·é›¢</label>
                            <select id="distance" name="distance" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="25">25m</option>
                                <option value="50">50m</option>
                                <option value="100">100m</option>
                                <option value="200">200m</option>
                                <option value="400">400m</option>
                                <option value="800">800m</option>
                                <option value="1500">1500m</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pool">ãƒ—ãƒ¼ãƒ«</label>
                            <select id="pool" name="pool" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="çŸ­æ°´è·¯">çŸ­æ°´è·¯(25m)</option>
                                <option value="é•·æ°´è·¯">é•·æ°´è·¯(50m)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="time">ã‚¿ã‚¤ãƒ </label>
                            <input type="text" id="time" name="time" placeholder="ä¾‹: 26.15" required>
                        </div>
                        <div class="form-group">
                            <label for="rank">é †ä½</label>
                            <select id="rank" name="rank" onchange="toggleCustomRank()">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="1">1ä½</option>
                                <option value="2">2ä½</option>
                                <option value="3">3ä½</option>
                                <option value="4">4ä½</option>
                                <option value="5">5ä½</option>
                                <option value="6">6ä½</option>
                                <option value="7">7ä½</option>
                                <option value="8">8ä½</option>
                                <option value="9">9ä½</option>
                                <option value="10">10ä½</option>
                                <option value="custom">ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰</option>
                            </select>
                            <input type="text" id="custom-rank" name="custom-rank" placeholder="é †ä½ã‚’å…¥åŠ›" style="display: none; margin-top: 5px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="competition">å¤§ä¼šå</label>
                        <select id="competition" name="competition">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="memo">ãƒ¡ãƒ¢</label>
                        <input type="text" id="memo" name="memo" placeholder="ä»»æ„">
                    </div>
                    <button type="submit" class="btn">è¨˜éŒ²ã‚’è¿½åŠ </button>
                </form>
            </div>

            <div id="analysis" class="tab-content">
                <h2>ğŸ“ˆ åˆ†æ</h2>
                
                <!-- ã‚°ãƒ©ãƒ•é¸æŠãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="chart-controls" style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>ğŸ“Š è¨˜éŒ²ã‚°ãƒ©ãƒ•è¨­å®š</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chart-stroke">ç¨®ç›®</label>
                            <select id="chart-stroke" onchange="updateChart()">
                                <option value="">ç¨®ç›®ã‚’é¸æŠ</option>
                                <option value="ãƒã‚¿ãƒ•ãƒ©ã‚¤">ãƒã‚¿ãƒ•ãƒ©ã‚¤</option>
                                <option value="è‡ªç”±å½¢">è‡ªç”±å½¢</option>
                                <option value="èƒŒæ³³ã">èƒŒæ³³ã</option>
                                <option value="å¹³æ³³ã">å¹³æ³³ã</option>
                                <option value="å€‹äººãƒ¡ãƒ‰ãƒ¬ãƒ¼">å€‹äººãƒ¡ãƒ‰ãƒ¬ãƒ¼</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chart-distance">è·é›¢</label>
                            <select id="chart-distance" onchange="updateChart()">
                                <option value="">è·é›¢ã‚’é¸æŠ</option>
                                <option value="50">50m</option>
                                <option value="100">100m</option>
                                <option value="200">200m</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chart-pool">ãƒ—ãƒ¼ãƒ«</label>
                            <select id="chart-pool" onchange="updateChart()">
                                <option value="">ãƒ—ãƒ¼ãƒ«ã‚’é¸æŠ</option>
                                <option value="çŸ­æ°´è·¯">çŸ­æ°´è·¯</option>
                                <option value="é•·æ°´è·¯">é•·æ°´è·¯</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="debug-info" style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; display: none;">
                        <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                        <span id="debug-content">Chart.jsèª­ã¿è¾¼ã¿çŠ¶æ³ç¢ºèªä¸­...</span>
                    </div>
                    
                    <button onclick="testChart()" class="btn" style="margin-top: 10px; font-size: 14px;">ğŸ“Š ã‚°ãƒ©ãƒ•æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
                    <button onclick="clearCache()" class="btn" style="margin-top: 10px; margin-left: 10px; font-size: 14px; background: #dc2626;">ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
                </div>

                <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="recordChart"></canvas>
                    </div>
                </div>

                <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚¨ãƒªã‚¢ -->
                <div id="advice-section" style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <h3>ğŸ’ª å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
                    <div id="advice-content"></div>
                </div>

                <div id="analysis-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="butterfly-count">-</h3>
                            <p>ãƒã‚¿ãƒ•ãƒ©ã‚¤è¨˜éŒ²æ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="freestyle-count">-</h3>
                            <p>è‡ªç”±å½¢è¨˜éŒ²æ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="recent-improvement">-</h3>
                            <p>ç›´è¿‘ã®å‘ä¸Šç‡</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="best-stroke">-</h3>
                            <p>æœ€ã‚‚å¾—æ„ãªç¨®ç›®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="data-manager" class="tab-content">
                <h2>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="exportData()" style="margin-right: 10px;">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn" onclick="importData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="resetData()" style="background: #dc2626;">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <div id="data-info">
                    <p>ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: <span id="current-data-count">-</span></p>
                    <p>æœ€çµ‚æ›´æ–°: <span id="last-updated">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let records = [];
        let currentTab = 'dashboard';
        let deferredPrompt;

        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨APIã‹ã‚‰å‹•çš„èª­ã¿è¾¼ã¿

        // PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯¾å¿œ
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-prompt').classList.add('show');
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }

        function hideInstallPrompt() {
            document.getElementById('install-prompt').classList.remove('show');
        }

        // Service Worker ç™»éŒ²
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†é–¢æ•°
        async function loadFromStorage() {
            const stored = localStorage.getItem('swimRecords');
            if (stored) {
                const data = JSON.parse(stored);
                // ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¤ã„å ´åˆã¯å¼·åˆ¶çš„ã«APIã‹ã‚‰å†å–å¾—
                if (!data.metadata || !data.metadata.version || data.records.length < 183) {
                    console.log('ãƒ‡ãƒ¼ã‚¿ãŒå¤ã„ãŸã‚ã€APIã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™');
                    localStorage.removeItem('swimRecords');
                    await loadFromAPI();
                } else {
                    records = data.records || [];
                }
            } else {
                // localStorageãŒç©ºã®å ´åˆã¯APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                await loadFromAPI();
            }
        }

        async function loadFromAPI() {
            try {
                // GitHub Pagesç’°å¢ƒã§ã¯ç›´æ¥JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                const response = await fetch('./data/swim-records.json');
                if (response.ok) {
                    const data = await response.json();
                    records = data.records || [];
                    saveToStorage(); // APIã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¿å­˜
                    console.log(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${records.length}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰`);
                } else {
                    console.error('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    records = [];
                }
            } catch (error) {
                console.error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                records = [];
            }
        }

        function saveToStorage() {
            const data = {
                records: records,
                metadata: {
                    totalRecords: records.length,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0.0"
                }
            };
            localStorage.setItem('swimRecords', JSON.stringify(data));
        }

        function generateId() {
            if (records.length === 0) return '001';
            const maxId = Math.max(...records.map(r => parseInt(r.id)));
            return String(maxId + 1).padStart(3, '0');
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
            
            if (tabName === 'records') {
                renderRecords();
            } else if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'analysis') {
                // åˆ†æã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸæ™‚ã«ã‚°ãƒ©ãƒ•ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                document.querySelector('.chart-container').style.display = 'none';
                document.getElementById('advice-section').style.display = 'none';
                document.getElementById('advice-content').innerHTML = '';
                document.getElementById('debug-info').style.display = 'none';
                updateAnalysis();
            } else if (tabName === 'data-manager') {
                updateDataManager();
            }
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
        function renderRecords(filteredRecords = null) {
            const tbody = document.getElementById('records-tbody');
            tbody.innerHTML = '';
            
            const recordsToShow = filteredRecords || records;
            
            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„ã‚‚ã®ã‹ã‚‰ï¼‰
            const sortedRecords = recordsToShow.sort((a, b) => {
                return new Date(b.æ—¥ä»˜) - new Date(a.æ—¥ä»˜);
            });
            
            sortedRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.æ—¥ä»˜}</td>
                    <td>${record.ç¨®ç›®}</td>
                    <td>${record.è·é›¢}m</td>
                    <td>${record.ãƒ—ãƒ¼ãƒ«}</td>
                    <td>${record.ã‚¿ã‚¤ãƒ }</td>
                    <td>${record.å¤§ä¼šå}</td>
                    <td>${record.é †ä½}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">å‰Šé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
        function filterRecords() {
            const strokeFilter = document.getElementById('filter-stroke').value;
            const distanceFilter = document.getElementById('filter-distance').value;
            const poolFilter = document.getElementById('filter-pool').value;
            const competitionFilter = document.getElementById('filter-competition').value;
            
            let filtered = records;
            
            if (strokeFilter) {
                filtered = filtered.filter(r => r.ç¨®ç›® === strokeFilter);
            }
            
            if (distanceFilter) {
                filtered = filtered.filter(r => r.è·é›¢ === distanceFilter);
            }
            
            if (poolFilter) {
                filtered = filtered.filter(r => r.ãƒ—ãƒ¼ãƒ« === poolFilter);
            }
            
            if (competitionFilter) {
                filtered = filtered.filter(r => r.å¤§ä¼šå === competitionFilter);
            }
            
            renderRecords(filtered);
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            document.getElementById('total-records').textContent = records.length;
            
            const butterflyRecords = records.filter(r => r.ç¨®ç›® === 'ãƒã‚¿ãƒ•ãƒ©ã‚¤' && r.è·é›¢ === '50');
            if (butterflyRecords.length > 0) {
                const bestTime = Math.min(...butterflyRecords.map(r => parseFloat(r.ã‚¿ã‚¤ãƒ )));
                document.getElementById('best-time').textContent = bestTime.toFixed(2) + 's';
            }
            
            const competitions = [...new Set(records.map(r => r.å¤§ä¼šå))].filter(c => c);
            document.getElementById('competitions').textContent = competitions.length;
            
            const firstPlaces = records.filter(r => r.é †ä½ === '1ä½').length;
            document.getElementById('first-places').textContent = firstPlaces;
        }

        // åˆ†æç”»é¢æ›´æ–°
        function updateAnalysis() {
            const butterflyCount = records.filter(r => r.ç¨®ç›® === 'ãƒã‚¿ãƒ•ãƒ©ã‚¤').length;
            const freestyleCount = records.filter(r => r.ç¨®ç›® === 'è‡ªç”±å½¢').length;
            
            document.getElementById('butterfly-count').textContent = butterflyCount;
            document.getElementById('freestyle-count').textContent = freestyleCount;
            
            // æœ€ã‚‚å¾—æ„ãªç¨®ç›®
            const strokeCounts = {};
            records.forEach(r => {
                strokeCounts[r.ç¨®ç›®] = (strokeCounts[r.ç¨®ç›®] || 0) + 1;
            });
            
            const bestStroke = Object.keys(strokeCounts).reduce((a, b) => 
                strokeCounts[a] > strokeCounts[b] ? a : b
            );
            document.getElementById('best-stroke').textContent = bestStroke;
            
            // ç›´è¿‘ã®å‘ä¸Šç‡
            const recentRecords = records
                .filter(r => r.ç¨®ç›® === 'ãƒã‚¿ãƒ•ãƒ©ã‚¤' && r.è·é›¢ === '50')
                .sort((a, b) => new Date(b.æ—¥ä»˜) - new Date(a.æ—¥ä»˜))
                .slice(0, 5);
            
            if (recentRecords.length >= 2) {
                const latest = parseFloat(recentRecords[0].ã‚¿ã‚¤ãƒ );
                const previous = parseFloat(recentRecords[1].ã‚¿ã‚¤ãƒ );
                const improvement = ((previous - latest) / previous * 100).toFixed(1);
                document.getElementById('recent-improvement').textContent = improvement + '%';
            } else {
                document.getElementById('recent-improvement').textContent = 'N/A';
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢æ›´æ–°
        function updateDataManager() {
            document.getElementById('current-data-count').textContent = records.length;
            const stored = localStorage.getItem('swimRecords');
            if (stored) {
                const data = JSON.parse(stored);
                document.getElementById('last-updated').textContent = 
                    new Date(data.metadata.lastUpdated).toLocaleString('ja-JP');
            }
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤
        function deleteRecord(recordId) {
            if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                records = records.filter(r => r.id !== recordId);
                saveToStorage();
                renderRecords();
                updateDashboard();
            }
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰è¿½åŠ 
        document.getElementById('record-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // é †ä½ã®å€¤ã‚’å–å¾—ï¼ˆã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ï¼‰
            let rankValue = formData.get('rank');
            if (rankValue === 'custom') {
                rankValue = formData.get('custom-rank');
            }
            
            const record = {
                id: generateId(),
                æ—¥ä»˜: formData.get('date'),
                ç¨®ç›®: formData.get('stroke'),
                è·é›¢: formData.get('distance'),
                ãƒ—ãƒ¼ãƒ«: formData.get('pool'),
                ã‚¿ã‚¤ãƒ : formData.get('time'),
                ç¨®åˆ¥: 'å¤§ä¼š',
                å¤§ä¼šå: formData.get('competition'),
                ãƒ¬ãƒ¼ã‚¹: '',
                é †ä½: rankValue,
                ãƒ¡ãƒ¢: formData.get('memo'),
                å…¥åŠ›è€…: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                æ›´æ–°æ—¥æ™‚: new Date().toISOString()
            };
            
            records.push(record);
            saveToStorage();
            alert('è¨˜éŒ²ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ');
            e.target.reset();
            
            // ã‚«ã‚¹ã‚¿ãƒ é †ä½å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('custom-rank').style.display = 'none';
            
            if (currentTab === 'records') {
                renderRecords();
            }
            updateDashboard();
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚æ›´æ–°
            populateFilters();
        });

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const data = {
                records: records,
                metadata: {
                    totalRecords: records.length,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0.0"
                }
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `swim-records-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.records && Array.isArray(data.records)) {
                            records = data.records;
                            saveToStorage();
                            renderRecords();
                            updateDashboard();
                            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                        } else {
                            alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                        }
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        function resetData() {
            if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                records = initialData.records;
                saveToStorage();
                renderRecords();
                updateDashboard();
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFromStorage();
            updateDashboard();
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
            document.getElementById('date').valueAsDate = new Date();
        });

        // Service Workerç„¡åŠ¹åŒ–ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œè§£æ±ºã®ãŸã‚ï¼‰
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }

        // ã‚¿ãƒƒãƒæ“ä½œæ”¹å–„
        document.addEventListener('touchstart', function() {}, {passive: true});
        document.addEventListener('touchmove', function() {}, {passive: true});

        // ã‚°ãƒ©ãƒ•å¤‰æ•°
        let recordChart = null;

        // ã‚¿ã‚¤ãƒ å¤‰æ›é–¢æ•°ï¼ˆåˆ†:ç§’å½¢å¼ã‚’ç§’æ•°ã«å¤‰æ›ï¼‰
        function parseTimeToSeconds(timeString) {
            if (!timeString) return 0;
            
            // æ—¢ã«ç§’æ•°ã®å ´åˆï¼ˆå°æ•°ç‚¹ã‚’å«ã‚€æ•°å€¤ï¼‰
            if (/^\d+(\.\d+)?$/.test(timeString)) {
                return parseFloat(timeString);
            }
            
            // åˆ†:ç§’å½¢å¼ã®å ´åˆï¼ˆä¾‹: "01:00.08" ã¾ãŸã¯ "1:30.45"ï¼‰
            const timeMatch = timeString.match(/^(\d{1,2}):(\d{2})\.?(\d{2})?$/);
            if (timeMatch) {
                const minutes = parseInt(timeMatch[1], 10);
                const seconds = parseInt(timeMatch[2], 10);
                const hundredths = timeMatch[3] ? parseInt(timeMatch[3], 10) : 0;
                return minutes * 60 + seconds + hundredths / 100;
            }
            
            // ãã®ä»–ã®å½¢å¼ï¼ˆä¾‹: "26.15"ï¼‰
            return parseFloat(timeString) || 0;
        }

        // ç§’æ•°ã‚’åˆ†:ç§’å½¢å¼ã«å¤‰æ›ï¼ˆè¡¨ç¤ºç”¨ï¼‰
        function formatSecondsToTime(seconds) {
            if (seconds < 60) {
                return seconds.toFixed(2) + 'ç§’';
            } else {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toFixed(2).padStart(5, '0')}`;
            }
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢é–¢æ•°
        function clearCache() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
            
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            alert('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ†ã‚¹ãƒˆé–¢æ•°
        function testChart() {
            const debugDiv = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            debugDiv.style.display = 'block';
            
            let debug = '';
            
            // Chart.js ã®ç¢ºèª
            if (typeof Chart !== 'undefined') {
                debug += 'âœ… Chart.js èª­ã¿è¾¼ã¿æˆåŠŸ<br>';
                debug += `Chart.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${Chart.version}<br>`;
            } else {
                debug += 'âŒ Chart.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“<br>';
            }
            
            // Canvasè¦ç´ ã®ç¢ºèª
            const canvas = document.getElementById('recordChart');
            if (canvas) {
                debug += 'âœ… Canvasè¦ç´ ã‚ã‚Š<br>';
                debug += `Canvas ã‚µã‚¤ã‚º: ${canvas.width}x${canvas.height}<br>`;
            } else {
                debug += 'âŒ Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>';
            }
            
            // ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
            debug += `ğŸ“Š ç·è¨˜éŒ²æ•°: ${records.length}<br>`;
            debug += `ãƒã‚¿ãƒ•ãƒ©ã‚¤50mçŸ­æ°´è·¯: ${records.filter(r => r.ç¨®ç›® === 'ãƒã‚¿ãƒ•ãƒ©ã‚¤' && r.è·é›¢ === '50' && r.ãƒ—ãƒ¼ãƒ« === 'çŸ­æ°´è·¯').length}ä»¶<br>`;
            
            // ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚°ãƒ©ãƒ•ä½œæˆ
            if (typeof Chart !== 'undefined') {
                try {
                    // Chart.jsã®å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¯ãƒªã‚¢
                    Chart.helpers.each(Chart.instances, function(instance) {
                        instance.destroy();
                    });
                    
                    // recordChartã‚’nullã«è¨­å®š
                    recordChart = null;
                    
                    // Canvasè¦ç´ ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
                    const chartContainer = document.querySelector('.chart-container div');
                    chartContainer.innerHTML = '<canvas id="recordChart"></canvas>';
                    
                    const canvas = document.getElementById('recordChart');
                    recordChart = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['1æœˆ', '2æœˆ', '3æœˆ'],
                            datasets: [{
                                label: 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿',
                                data: [30, 28, 26],
                                borderColor: '#2563eb',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'ãƒ†ã‚¹ãƒˆã‚°ãƒ©ãƒ•'
                                }
                            }
                        }
                    });
                    
                    document.querySelector('.chart-container').style.display = 'block';
                    debug += 'âœ… ãƒ†ã‚¹ãƒˆã‚°ãƒ©ãƒ•ä½œæˆæˆåŠŸï¼<br>';
                } catch (error) {
                    debug += `âŒ ã‚°ãƒ©ãƒ•ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}<br>`;
                }
            }
            
            debugContent.innerHTML = debug;
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°é–¢æ•°
        function updateChart() {
            try {
                // ã¾ãšå¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚°ãƒ©ãƒ•ã‚’ã‚¯ãƒªã‚¢
                document.querySelector('.chart-container').style.display = 'none';
                document.getElementById('advice-section').style.display = 'none';
                document.getElementById('advice-content').innerHTML = '';
                document.getElementById('debug-info').style.display = 'none';

                const stroke = document.getElementById('chart-stroke').value;
                const distance = document.getElementById('chart-distance').value;
                const pool = document.getElementById('chart-pool').value;

                if (!stroke || !distance) {
                    document.querySelector('.chart-container').style.display = 'none';
                    document.getElementById('advice-section').style.display = 'none';
                    // å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('advice-content').innerHTML = '';
                    return;
                }

                // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                let filteredRecords = records.filter(record => 
                    record.ç¨®ç›® === stroke && record.è·é›¢ === distance
                );

                if (pool) {
                    filteredRecords = filteredRecords.filter(record => record.ãƒ—ãƒ¼ãƒ« === pool);
                }

                // ãƒ—ãƒ¼ãƒ«é¸æŠã«å¿œã˜ã¦å¯¾æ¯”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let compareRecords = [];
                if (pool === 'é•·æ°´è·¯') {
                    // é•·æ°´è·¯é¸æŠæ™‚ã¯çŸ­æ°´è·¯ãƒ‡ãƒ¼ã‚¿ã‚‚å–å¾—
                    compareRecords = records.filter(record => 
                        record.ç¨®ç›® === stroke && record.è·é›¢ === distance && record.ãƒ—ãƒ¼ãƒ« === 'çŸ­æ°´è·¯'
                    );
                } else if (pool === 'çŸ­æ°´è·¯') {
                    // çŸ­æ°´è·¯é¸æŠæ™‚ã¯é•·æ°´è·¯ãƒ‡ãƒ¼ã‚¿ã‚‚å–å¾—
                    compareRecords = records.filter(record => 
                        record.ç¨®ç›® === stroke && record.è·é›¢ === distance && record.ãƒ—ãƒ¼ãƒ« === 'é•·æ°´è·¯'
                    );
                }

                if (filteredRecords.length === 0 && compareRecords.length === 0) {
                    document.querySelector('.chart-container').style.display = 'none';
                    document.getElementById('advice-section').style.display = 'none';
                    // å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('advice-content').innerHTML = '';
                    
                    // ãƒ‡ãƒ¼ã‚¿ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `âŒ ${stroke} ${distance}m ${pool || 'ã™ã¹ã¦'} ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>ãƒ•ã‚£ãƒ«ã‚¿å¾Œ: ${filteredRecords.length}ä»¶, æ¯”è¼ƒ: ${compareRecords.length}ä»¶`;
                    return;
                }

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’éš ã™
                document.getElementById('debug-info').style.display = 'none';

                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ãƒˆï¼ˆæ—¥ä»˜é †ï¼‰
                filteredRecords.sort((a, b) => new Date(a.æ—¥ä»˜) - new Date(b.æ—¥ä»˜));
                compareRecords.sort((a, b) => new Date(a.æ—¥ä»˜) - new Date(b.æ—¥ä»˜));

                // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿æº–å‚™
                const datasets = [];

                if (filteredRecords.length > 0) {
                    datasets.push({
                        label: `${stroke} ${distance}m (${pool || 'All'})`,
                        data: filteredRecords.map(record => ({
                            x: record.æ—¥ä»˜,
                            y: parseTimeToSeconds(record.ã‚¿ã‚¤ãƒ )
                        })),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: false,
                        tension: 0.1
                    });
                }

                if (compareRecords.length > 0) {
                    const compareLabel = pool === 'é•·æ°´è·¯' ? 'çŸ­æ°´è·¯å‚è€ƒ' : 'é•·æ°´è·¯å‚è€ƒ';
                    datasets.push({
                        label: `${stroke} ${distance}m (${compareLabel})`,
                        data: compareRecords.map(record => ({
                            x: record.æ—¥ä»˜,
                            y: parseTimeToSeconds(record.ã‚¿ã‚¤ãƒ )
                        })),
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5]
                    });
                }

                // ã‚°ãƒ©ãƒ•ä½œæˆ
                const success = createChart(datasets);
                
                if (success) {
                    // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
                    generateAdvice(stroke, distance, pool, filteredRecords);

                    // è¡¨ç¤º
                    document.querySelector('.chart-container').style.display = 'block';
                    document.getElementById('advice-section').style.display = 'block';
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `âœ… ã‚°ãƒ©ãƒ•ä½œæˆæˆåŠŸï¼ ãƒ‡ãƒ¼ã‚¿: ${filteredRecords.length}ä»¶`;
                    setTimeout(() => {
                        debugDiv.style.display = 'none';
                    }, 3000);
                } else {
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `âŒ ã‚°ãƒ©ãƒ•ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ`;
                }
                
            } catch (error) {
                console.error('updateChart ã‚¨ãƒ©ãƒ¼:', error);
                const debugDiv = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugDiv.style.display = 'block';
                debugContent.innerHTML = `âŒ ã‚°ãƒ©ãƒ•æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        function createChart(datasets) {
            try {
                console.log('createCharté–‹å§‹, datasets:', datasets);
                
                // Chart.jsã®å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¯ãƒªã‚¢
                if (Chart.instances) {
                    Chart.helpers.each(Chart.instances, function(instance) {
                        instance.destroy();
                    });
                }
                
                // recordChartã‚’nullã«è¨­å®š
                recordChart = null;

                // Canvasè¦ç´ ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
                const chartContainer = document.querySelector('.chart-container div');
                if (!chartContainer) {
                    console.error('Chart container not found');
                    return false;
                }
                
                chartContainer.innerHTML = '<canvas id="recordChart"></canvas>';
                
                const canvas = document.getElementById('recordChart');
                if (!canvas) {
                    console.error('Canvas element not found');
                    return false;
                }
                
                const ctx = canvas.getContext('2d');
                console.log('Canvasæº–å‚™å®Œäº†');

                // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’å˜ç´”ãªå½¢å¼ã«å¤‰æ›
                const labels = [];
                const processedDatasets = [];
                
                datasets.forEach(dataset => {
                    const processedData = dataset.data.map(point => {
                        const date = new Date(point.x);
                        const label = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                        if (!labels.includes(label)) {
                            labels.push(label);
                        }
                        return {
                            label: label,
                            value: point.y
                        };
                    });
                    
                    processedDatasets.push({
                        ...dataset,
                        processedData: processedData
                    });
                });
                
                // ãƒ©ãƒ™ãƒ«ã‚’ã‚½ãƒ¼ãƒˆ
                const sortedLabels = labels.sort((a, b) => new Date(a) - new Date(b));
                
                // å„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’æ•´ç†
                const finalDatasets = processedDatasets.map(dataset => ({
                    ...dataset,
                    data: sortedLabels.map(label => {
                        const dataPoint = dataset.processedData.find(p => p.label === label);
                        return dataPoint ? dataPoint.value : null;
                    })
                }));

                recordChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedLabels,
                        datasets: finalDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'è¨˜éŒ²æ¨ç§»ã‚°ãƒ©ãƒ•'
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥ä»˜'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'ã‚¿ã‚¤ãƒ '
                                },
                                reverse: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatSecondsToTime(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('Chartä½œæˆæˆåŠŸ');
                
                return true;
            } catch (error) {
                console.error('ã‚°ãƒ©ãƒ•ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                const debugDiv = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugDiv.style.display = 'block';
                debugContent.innerHTML = `âŒ ã‚°ãƒ©ãƒ•ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}<br>è©³ç´°: ${error.stack}`;
                return false;
            }
        }

        // æœ€è¿‘ã®è¨˜éŒ²ã‚’åˆ†æã™ã‚‹é–¢æ•°
        function analyzeRecentRecords(records) {
            if (records.length < 2) {
                return {
                    trend: 'initial',
                    message: 'è¨˜éŒ²ãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ãŸã°ã‹ã‚Šï¼ã“ã‚Œã‹ã‚‰ã®æˆé•·ãŒæ¥½ã—ã¿ã§ã™ã­ï¼',
                    detail: 'æœ€åˆã®ä¸€æ­©ãŒè¸ã¿å‡ºã›ã¾ã—ãŸã€‚ç¶™ç¶šã¯åŠ›ãªã‚Šã€ãŒã‚“ã°ã‚Šã¾ã—ã‚‡ã†ï¼'
                };
            }

            // ç›´è¿‘5å›ã®è¨˜éŒ²ã‚’å–å¾—ï¼ˆæ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
            const recentCount = Math.min(5, records.length);
            const recentRecords = records.slice(-recentCount);
            const times = recentRecords.map(r => parseTimeToSeconds(r.ã‚¿ã‚¤ãƒ ));
            
            // å‚¾å‘åˆ†æ
            let improvements = 0;
            let stable = 0;
            let challenges = 0;
            
            for (let i = 1; i < times.length; i++) {
                const diff = times[i-1] - times[i]; // å‰å›ã¨ã®å·®ï¼ˆæ­£ãªã‚‰å‘ä¸Šï¼‰
                if (diff > 0.1) improvements++;
                else if (Math.abs(diff) <= 0.1) stable++;
                else challenges++;
            }
            
            // æœ€æ–°3å›ã®å¹³å‡ã¨å‰ã®è¨˜éŒ²ã®æ¯”è¼ƒ
            const latest3 = times.slice(-3);
            const earlier3 = times.slice(-6, -3);
            const latest3Avg = latest3.reduce((a, b) => a + b, 0) / latest3.length;
            const earlier3Avg = earlier3.length > 0 ? earlier3.reduce((a, b) => a + b, 0) / earlier3.length : latest3Avg;
            
            // ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‹ã‚‰ã®ä½ç½®
            const bestTime = Math.min(...times);
            const latestTime = times[times.length - 1];
            const gapFromBest = latestTime - bestTime;
            
            // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
            let trend, message, detail;
            
            if (improvements >= challenges && latest3Avg <= earlier3Avg) {
                trend = 'improving';
                const messages = [
                    'ç´ æ™´ã‚‰ã—ã„å‘ä¸Šå‚¾å‘ã§ã™ï¼ç¶™ç¶šã—ãŸåŠªåŠ›ã®æˆæœãŒç¾ã‚Œã¦ã„ã¾ã™ï¼',
                    'ç€å®Ÿã«ã‚¿ã‚¤ãƒ ãŒç¸®ã¾ã£ã¦ã„ã¾ã™ï¼ã“ã®èª¿å­ã§æ›´ãªã‚‹é«˜ã¿ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼',
                    'æˆé•·ã‚«ãƒ¼ãƒ–ãŒå³è‚©ä¸ŠãŒã‚Šã§ã™ï¼ç·´ç¿’ã®è³ªãŒå‘ä¸Šã—ã¦ã„ã‚‹è¨¼æ‹ ã§ã™ã­ï¼'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = gapFromBest < 1 ? 
                    'ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã«è¿«ã‚‹ç´ æ™´ã‚‰ã—ã„ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã§ã™ï¼' : 
                    `ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã¾ã§${gapFromBest.toFixed(2)}ç§’ã€‚ã‚‚ã†ä¸€æŠ¼ã—ã§ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¹ãƒ«ãƒ¼ã§ã™ï¼`;
            } else if (stable > improvements && stable > challenges) {
                trend = 'stable';
                const messages = [
                    'å®‰å®šã—ãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¶­æŒã—ã¦ã„ã¾ã™ï¼ã“ã®å®‰å®šæ„ŸãŒæ¬¡ã®é£›èºã®åŸºç›¤ã§ã™ï¼',
                    'ã‚³ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆã«è‰¯ã„ã‚¿ã‚¤ãƒ ã‚’ã‚­ãƒ¼ãƒ—ï¼æŠ€è¡“çš„ãªæˆç†Ÿã‚’æ„Ÿã˜ã¾ã™ï¼',
                    'ä¸€å®šãƒ¬ãƒ™ãƒ«ã®å®ŸåŠ›ã‚’ã—ã£ã‹ã‚Šç¶­æŒï¼ã“ã®å®‰å®šæ€§ã“ããŒç«¶æŠ€è€…ã®è¨¼ã§ã™ï¼'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = 'ã“ã®å®‰å®šæ„Ÿã‹ã‚‰ä¸€æ°—ã«ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¹ãƒ«ãƒ¼ã™ã‚‹ç¬é–“ãŒå¿…ãšæ¥ã¾ã™ï¼';
            } else {
                trend = 'challenging';
                const messages = [
                    'æ–°ã—ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«å–ã‚Šçµ„ã‚“ã§ã„ã‚‹è¨¼æ‹ ã§ã™ï¼æŒ‘æˆ¦ã¯æˆé•·ã®æºã§ã™ï¼',
                    'ã‚ˆã‚Šé«˜ã„ç›®æ¨™ã«å‘ã‹ã£ã¦ã„ã‚‹éç¨‹ã§ã™ã­ï¼ã“ã®çµŒé¨“ãŒå¿…ãšæ´»ã‹ã•ã‚Œã¾ã™ï¼',
                    'æ–°ã—ã„æŠ€è¡“ã‚„æˆ¦ç•¥ã‚’è©¦è¡ŒéŒ¯èª¤ä¸­ï¼ã“ã®ç©æ¥µæ€§ãŒæˆåŠŸã¸ã®éµã§ã™ï¼'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®å…ˆã«ã¯å¿…ãšå¤§ããªæˆé•·ãŒå¾…ã£ã¦ã„ã¾ã™ï¼';
            }
            
            return { trend, message, detail };
        }

        function generateAdvice(stroke, distance, pool, records) {
            if (records.length === 0) return;

            const bestTime = Math.min(...records.map(r => parseTimeToSeconds(r.ã‚¿ã‚¤ãƒ )));
            const latestTime = parseTimeToSeconds(records[records.length - 1].ã‚¿ã‚¤ãƒ );
            const improvement = records.length > 1 ? 
                parseTimeToSeconds(records[0].ã‚¿ã‚¤ãƒ ) - parseTimeToSeconds(records[records.length - 1].ã‚¿ã‚¤ãƒ ) : 0;

            // æœ€è¿‘ã®è¨˜éŒ²åˆ†æ
            const recentAnalysis = analyzeRecentRecords(records);

            let advice = `<div style="line-height: 1.6;">`;
            
            // ç¨®ç›®åˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹
            const strokeAdvice = {
                'ãƒã‚¿ãƒ•ãƒ©ã‚¤': {
                    tips: ['ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ„è­˜ã—ã¦ï¼', 'ã‚­ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒãƒã‚¤ãƒ³ãƒˆï¼', 'è‚©ã®æŸ”è»Ÿæ€§ã‚’é«˜ã‚ã‚ˆã†ï¼'],
                    motivation: 'ç¾ã—ã„ãƒã‚¿ãƒ•ãƒ©ã‚¤ã§æ°´é¢ã‚’åˆ¶è¦‡ã—ã‚ˆã†ï¼ğŸ¦‹'
                },
                'è‡ªç”±å½¢': {
                    tips: ['ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã¿ã‚ˆã†ï¼', 'ã‚­ãƒ£ãƒƒãƒã‚’ã—ã£ã‹ã‚Šã¨ï¼', 'ã‚¿ãƒ¼ãƒ³ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ã‚’ç›®æŒ‡ãã†ï¼'],
                    motivation: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ã®ç‹æ§˜ã€è‡ªç”±å½¢ã§é¢¨ã®ã‚ˆã†ã«æ³³ã”ã†ï¼ğŸŒŠ'
                },
                'èƒŒæ³³ã': {
                    tips: ['ä½“ã®è»¸ã‚’ã¾ã£ã™ãã«ï¼', 'ãƒ•ãƒ©ãƒƒã‚°ã‹ã‚‰ã®è·é›¢æ„Ÿã‚’æ´ã‚‚ã†ï¼', 'è…°ã®ä½ç½®ã‚’é«˜ãä¿ã¨ã†ï¼'],
                    motivation: 'ç©ºã‚’è¦‹ãªãŒã‚‰ã€æœ€é«˜ã®ã‚¿ã‚¤ãƒ ã‚’ç›®æŒ‡ãã†ï¼â˜ï¸'
                },
                'å¹³æ³³ã': {
                    tips: ['ä¸€æ»ãä¸€è¹´ã‚Šã‚’å¤§åˆ‡ã«ï¼', 'ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ©ã‚¤ãƒ³ã®æ™‚é–“ã‚’é•·ãï¼', 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒå‘½ï¼'],
                    motivation: 'æŠ€è¡“ã®å¹³æ³³ãã€ç¾ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã§å‹è² ï¼ğŸ¸'
                },
                'å€‹äººãƒ¡ãƒ‰ãƒ¬ãƒ¼': {
                    tips: ['å„ç¨®ç›®ã®ã¤ãªãã‚’æ„è­˜ã—ã¦ï¼', 'ãƒšãƒ¼ã‚¹é…åˆ†ãŒé‡è¦ï¼', 'æœ€å¾Œã¾ã§è«¦ã‚ãªã„å¿ƒã‚’ï¼'],
                    motivation: 'ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ€ãƒ¼ã®è¨¼ã€IM ã§ç·åˆåŠ›ã‚’è¦‹ã›ã¤ã‘ã‚ˆã†ï¼ğŸ†'
                }
            };

            const currentStroke = strokeAdvice[stroke] || strokeAdvice['è‡ªç”±å½¢'];
            
            advice += `<p><strong>ğŸ¯ ${stroke} ${distance}m ã®åˆ†æçµæœ</strong></p>`;
            advice += `<p>ğŸ“ˆ ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ : <span style="color: #059669; font-weight: bold;">${formatSecondsToTime(bestTime)}</span></p>`;
            advice += `<p>ğŸ“Š ç›´è¿‘ã®ã‚¿ã‚¤ãƒ : <span style="color: #2563eb; font-weight: bold;">${formatSecondsToTime(latestTime)}</span></p>`;
            
            if (improvement > 0) {
                advice += `<p>ğŸš€ ç·åˆå‘ä¸Šå¹…: <span style="color: #059669; font-weight: bold;">-${improvement.toFixed(2)}ç§’</span> ã™ã”ã„æˆé•·ã§ã™ï¼</p>`;
            } else if (improvement < 0) {
                advice += `<p>ğŸ’ª ã¾ã ã¾ã ä¼¸ã³ã—ã‚ãŒã‚ã‚Šã¾ã™ï¼æ¬¡ã“ããƒ™ã‚¹ãƒˆæ›´æ–°ã ï¼</p>`;
            }

            // æœ€è¿‘ã®è¨˜éŒ²åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            advice += `<br><div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">`;
            advice += `<p><strong>ğŸ” æœ€è¿‘ã®è¨˜éŒ²åˆ†æ</strong></p>`;
            advice += `<p style="color: #1e40af; font-weight: 600;">${recentAnalysis.message}</p>`;
            advice += `<p style="color: #374151; font-size: 0.95em;">${recentAnalysis.detail}</p>`;
            
            // è¨˜éŒ²æ•°ã«å¿œã˜ãŸè¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (records.length >= 10) {
                advice += `<p style="color: #059669; font-size: 0.9em; margin-top: 8px;">`;
                advice += `ğŸ–ï¸ ${records.length}å›ã®è¨˜éŒ²è“„ç©ï¼ç¶™ç¶šçš„ãªåŠªåŠ›ã®è³œç‰©ã§ã™ã€‚`;
                advice += `</p>`;
            } else if (records.length >= 5) {
                advice += `<p style="color: #0891b2; font-size: 0.9em; margin-top: 8px;">`;
                advice += `ğŸ“Š ${records.length}å›ã®è¨˜éŒ²ã§å‚¾å‘ãŒè¦‹ãˆã¦ãã¾ã—ãŸï¼`;
                advice += `</p>`;
            }
            advice += `</div>`;
            
            advice += `<br><p><strong>ğŸ’¡ ${stroke}ã®ã‚³ãƒ„</strong></p>`;
            advice += `<p>ãƒ»${currentStroke.tips[Math.floor(Math.random() * currentStroke.tips.length)]}</p>`;
            
            advice += `<br><p style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 15px;">`;
            advice += `${currentStroke.motivation}`;
            advice += `</p>`;
            
            advice += `<p style="text-align: center; margin-top: 10px; color: #666; font-style: italic;">`;
            advice += `ç·´ç¿’ã¯è£åˆ‡ã‚‰ãªã„ã€‚ä»Šæ—¥ã‚‚ãƒ™ã‚¹ãƒˆã‚’å°½ããã†ï¼âœ¨`;
            advice += `</p>`;
            
            advice += `</div>`;

            document.getElementById('advice-content').innerHTML = advice;
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
        function populateFilters() {
            // ãƒ—ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
            const poolSelect = document.getElementById('filter-pool');
            const pools = [...new Set(records.map(r => r.ãƒ—ãƒ¼ãƒ«))].filter(p => p).sort();
            pools.forEach(pool => {
                const option = document.createElement('option');
                option.value = pool;
                option.textContent = pool;
                poolSelect.appendChild(option);
            });

            // å¤§ä¼šåãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
            const competitionSelect = document.getElementById('filter-competition');
            const competitions = [...new Set(records.map(r => r.å¤§ä¼šå))].filter(c => c).sort();
            competitions.forEach(competition => {
                const option = document.createElement('option');
                option.value = competition;
                option.textContent = competition;
                competitionSelect.appendChild(option);
            });

            // è¨˜éŒ²è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®å¤§ä¼šåã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
            const addCompetitionSelect = document.getElementById('competition');
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã€Œé¸æŠã—ã¦ãã ã•ã„ã€ä»¥å¤–ï¼‰ã‚’ã‚¯ãƒªã‚¢
            while (addCompetitionSelect.children.length > 1) {
                addCompetitionSelect.removeChild(addCompetitionSelect.lastChild);
            }
            competitions.forEach(competition => {
                const option = document.createElement('option');
                option.value = competition;
                option.textContent = competition;
                addCompetitionSelect.appendChild(option);
            });
        }

        // é †ä½é¸æŠã®åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function toggleCustomRank() {
            const rankSelect = document.getElementById('rank');
            const customRankInput = document.getElementById('custom-rank');
            
            if (rankSelect.value === 'custom') {
                customRankInput.style.display = 'block';
                customRankInput.required = true;
            } else {
                customRankInput.style.display = 'none';
                customRankInput.required = false;
                customRankInput.value = '';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
            setTimeout(populateFilters, 1000);
        });
    </script>
</body>
</html>