<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Á´∂Ê≥≥Ë®òÈå≤ÁÆ°ÁêÜ„ÉªÂàÜÊûê„ÉªÁõÆÊ®ôË®≠ÂÆö„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>üèä‚Äç‚ôÇÔ∏è MinatoSwimRecord - Á´∂Ê≥≥Ë®òÈå≤ÁÆ°ÁêÜ„Ç¢„Éó„É™ - üöÄFIXED-1415üöÄ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .header h1 {
            color: #2563eb;
            font-size: 2.2em;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 1em;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
            touch-action: manipulation;
        }

        .nav-tab.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
            min-height: 48px;
            touch-action: manipulation;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            padding: 12px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            touch-action: manipulation;
            min-height: 48px;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            padding: 8px 12px;
            font-size: 14px;
            min-height: 36px;
        }

        .btn-danger:hover {
            background: #b91c1c;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .record-table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        .record-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .record-table th,
        .record-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .record-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        .record-table tr:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .stat-card p {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 33% { content: '.'; }
            34%, 66% { content: '..'; }
            67%, 100% { content: '...'; }
        }

        .install-prompt {
            background: rgba(37, 99, 235, 0.1);
            border: 2px solid #2563eb;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .install-prompt.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .nav-tabs {
                padding: 3px;
            }
            
            .nav-tab {
                padding: 10px 6px;
                font-size: 0.8em;
            }
            
            .content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card h3 {
                font-size: 1.6em;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .record-table th,
            .record-table td {
                padding: 8px 4px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .nav-tab {
                font-size: 0.75em;
                padding: 8px 4px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="install-prompt" id="install-prompt">
        <p>üì± „Åì„ÅÆ„Ç¢„Éó„É™„Çí„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åß„Åç„Åæ„ÅôÔºÅ</p>
        <button class="btn" onclick="installApp()">„Ç¢„Éó„É™„Çí„Ç§„É≥„Çπ„Éà„Éº„É´</button>
        <button class="btn" onclick="hideInstallPrompt()" style="background: #6b7280; margin-left: 10px;">Âæå„Åß</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üèä‚Äç‚ôÇÔ∏è MinatoSwimRecord</h1>
            <p>Á´∂Ê≥≥Ë®òÈå≤ÁÆ°ÁêÜ„ÉªÂàÜÊûê„ÉªÁõÆÊ®ôË®≠ÂÆö„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</button>
            <button class="nav-tab" onclick="showTab('records')">üìù Ë®òÈå≤‰∏ÄË¶ß</button>
            <button class="nav-tab" onclick="showTab('add-record')">‚ûï Ë®òÈå≤ËøΩÂä†</button>
            <button class="nav-tab" onclick="showTab('analysis')">üìà ÂàÜÊûê</button>
            <button class="nav-tab" onclick="showTab('data-manager')">üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <h2>üìä „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-records">-</h3>
                        <p>Á∑èË®òÈå≤Êï∞</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="best-time">-</h3>
                        <p>„Éô„Çπ„Éà„Çø„Ç§„É†(„Éê„Çø„Éï„É©„Ç§50m)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="competitions">-</h3>
                        <p>ÂèÇÂä†Â§ß‰ºöÊï∞</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="first-places">-</h3>
                        <p>1‰ΩçÁç≤ÂæóÊï∞</p>
                    </div>
                </div>
            </div>

            <div id="records" class="tab-content">
                <h2>üìù Ë®òÈå≤‰∏ÄË¶ß</h2>
                <div class="form-row" style="margin-bottom: 15px;">
                    <select id="filter-stroke" onchange="filterRecords()">
                        <option value="">ÂÖ®Á®ÆÁõÆ</option>
                        <option value="„Éê„Çø„Éï„É©„Ç§">„Éê„Çø„Éï„É©„Ç§</option>
                        <option value="Ëá™Áî±ÂΩ¢">Ëá™Áî±ÂΩ¢</option>
                        <option value="ËÉåÊ≥≥„Åé">ËÉåÊ≥≥„Åé</option>
                        <option value="Âπ≥Ê≥≥„Åé">Âπ≥Ê≥≥„Åé</option>
                        <option value="ÂÄã‰∫∫„É°„Éâ„É¨„Éº">ÂÄã‰∫∫„É°„Éâ„É¨„Éº</option>
                    </select>
                    <select id="filter-distance" onchange="filterRecords()">
                        <option value="">ÂÖ®Ë∑ùÈõ¢</option>
                        <option value="50">50m</option>
                        <option value="100">100m</option>
                        <option value="200">200m</option>
                    </select>
                    <select id="filter-pool" onchange="filterRecords()">
                        <option value="">ÂÖ®„Éó„Éº„É´</option>
                    </select>
                    <select id="filter-competition" onchange="filterRecords()">
                        <option value="">ÂÖ®Â§ß‰ºö</option>
                    </select>
                </div>
                <div class="record-table-container">
                    <table class="record-table" id="records-table">
                        <thead>
                            <tr>
                                <th>Êó•‰ªò</th>
                                <th>Á®ÆÁõÆ</th>
                                <th>Ë∑ùÈõ¢</th>
                                <th>„Éó„Éº„É´</th>
                                <th>„Çø„Ç§„É†</th>
                                <th>Â§ß‰ºöÂêç</th>
                                <th>È†Ü‰Ωç</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="records-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="add-record" class="tab-content">
                <h2>‚ûï Ë®òÈå≤ËøΩÂä†</h2>
                <form id="record-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Êó•‰ªò</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="stroke">Á®ÆÁõÆ</label>
                            <select id="stroke" name="stroke" required>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="Ëá™Áî±ÂΩ¢">Ëá™Áî±ÂΩ¢</option>
                                <option value="ËÉåÊ≥≥„Åé">ËÉåÊ≥≥„Åé</option>
                                <option value="Âπ≥Ê≥≥„Åé">Âπ≥Ê≥≥„Åé</option>
                                <option value="„Éê„Çø„Éï„É©„Ç§">„Éê„Çø„Éï„É©„Ç§</option>
                                <option value="ÂÄã‰∫∫„É°„Éâ„É¨„Éº">ÂÄã‰∫∫„É°„Éâ„É¨„Éº</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="distance">Ë∑ùÈõ¢</label>
                            <select id="distance" name="distance" required>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="25">25m</option>
                                <option value="50">50m</option>
                                <option value="100">100m</option>
                                <option value="200">200m</option>
                                <option value="400">400m</option>
                                <option value="800">800m</option>
                                <option value="1500">1500m</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pool">„Éó„Éº„É´</label>
                            <select id="pool" name="pool" required>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="Áü≠Ê∞¥Ë∑Ø">Áü≠Ê∞¥Ë∑Ø(25m)</option>
                                <option value="Èï∑Ê∞¥Ë∑Ø">Èï∑Ê∞¥Ë∑Ø(50m)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="time">„Çø„Ç§„É†</label>
                            <input type="text" id="time" name="time" placeholder="‰æã: 26.15" required>
                        </div>
                        <div class="form-group">
                            <label for="rank">È†Ü‰Ωç</label>
                            <select id="rank" name="rank" onchange="toggleCustomRank()">
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="1">1‰Ωç</option>
                                <option value="2">2‰Ωç</option>
                                <option value="3">3‰Ωç</option>
                                <option value="4">4‰Ωç</option>
                                <option value="5">5‰Ωç</option>
                                <option value="6">6‰Ωç</option>
                                <option value="7">7‰Ωç</option>
                                <option value="8">8‰Ωç</option>
                                <option value="9">9‰Ωç</option>
                                <option value="10">10‰Ωç</option>
                                <option value="custom">„Åù„ÅÆ‰ªñÔºàÊâãÂÖ•ÂäõÔºâ</option>
                            </select>
                            <input type="text" id="custom-rank" name="custom-rank" placeholder="È†Ü‰Ωç„ÇíÂÖ•Âäõ" style="display: none; margin-top: 5px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="competition">Â§ß‰ºöÂêç</label>
                        <select id="competition" name="competition">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="memo">„É°„É¢</label>
                        <input type="text" id="memo" name="memo" placeholder="‰ªªÊÑè">
                    </div>
                    <button type="submit" class="btn">Ë®òÈå≤„ÇíËøΩÂä†</button>
                </form>
            </div>

            <div id="analysis" class="tab-content">
                <h2>üìà ÂàÜÊûê</h2>
                
                <!-- „Ç∞„É©„ÉïÈÅ∏Êäû„Éï„Ç©„Éº„É† -->
                <div class="chart-controls" style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>üìä Ë®òÈå≤„Ç∞„É©„ÉïË®≠ÂÆö</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chart-stroke">Á®ÆÁõÆ</label>
                            <select id="chart-stroke" onchange="updateChart()">
                                <option value="">Á®ÆÁõÆ„ÇíÈÅ∏Êäû</option>
                                <option value="„Éê„Çø„Éï„É©„Ç§">„Éê„Çø„Éï„É©„Ç§</option>
                                <option value="Ëá™Áî±ÂΩ¢">Ëá™Áî±ÂΩ¢</option>
                                <option value="ËÉåÊ≥≥„Åé">ËÉåÊ≥≥„Åé</option>
                                <option value="Âπ≥Ê≥≥„Åé">Âπ≥Ê≥≥„Åé</option>
                                <option value="ÂÄã‰∫∫„É°„Éâ„É¨„Éº">ÂÄã‰∫∫„É°„Éâ„É¨„Éº</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chart-distance">Ë∑ùÈõ¢</label>
                            <select id="chart-distance" onchange="updateChart()">
                                <option value="">Ë∑ùÈõ¢„ÇíÈÅ∏Êäû</option>
                                <option value="50">50m</option>
                                <option value="100">100m</option>
                                <option value="200">200m</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chart-pool">„Éó„Éº„É´</label>
                            <select id="chart-pool" onchange="updateChart()">
                                <option value="">„Éó„Éº„É´„ÇíÈÅ∏Êäû</option>
                                <option value="Áü≠Ê∞¥Ë∑Ø">Áü≠Ê∞¥Ë∑Ø</option>
                                <option value="Èï∑Ê∞¥Ë∑Ø">Èï∑Ê∞¥Ë∑Ø</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫„Ç®„É™„Ç¢ -->
                    <div id="debug-info" style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; display: none;">
                        <strong>„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:</strong><br>
                        <span id="debug-content">Chart.jsË™≠„ÅøËæº„ÅøÁä∂Ê≥ÅÁ¢∫Ë™ç‰∏≠...</span>
                    </div>
                    
                    <button onclick="testChart()" class="btn" style="margin-top: 10px; font-size: 14px;">üìä „Ç∞„É©„ÉïÊ©üËÉΩ„ÉÜ„Çπ„Éà</button>
                    <button onclick="clearCache()" class="btn" style="margin-top: 10px; margin-left: 10px; font-size: 14px; background: #dc2626;">üîÑ „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢</button>
                </div>

                <!-- „Ç∞„É©„Éï„Ç®„É™„Ç¢ -->
                <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="recordChart"></canvas>
                    </div>
                </div>

                <!-- „Ç¢„Éâ„Éê„Ç§„Çπ„Ç®„É™„Ç¢ -->
                <div id="advice-section" style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <h3>üí™ ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏</h3>
                    <div id="advice-content"></div>
                </div>

                <div id="analysis-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="butterfly-count">-</h3>
                            <p>„Éê„Çø„Éï„É©„Ç§Ë®òÈå≤Êï∞</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="freestyle-count">-</h3>
                            <p>Ëá™Áî±ÂΩ¢Ë®òÈå≤Êï∞</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="recent-improvement">-</h3>
                            <p>Áõ¥Ëøë„ÅÆÂêë‰∏äÁéá</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="best-stroke">-</h3>
                            <p>ÊúÄ„ÇÇÂæóÊÑè„Å™Á®ÆÁõÆ</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="data-manager" class="tab-content">
                <h2>üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="exportData()" style="margin-right: 10px;">üì• „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button class="btn" onclick="importData()">üì§ „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="resetData()" style="background: #dc2626;">üîÑ „Éá„Éº„Çø„É™„Çª„ÉÉ„Éà</button>
                </div>
                <div id="data-info">
                    <p>ÁèæÂú®„ÅÆ„Éá„Éº„Çø‰ª∂Êï∞: <span id="current-data-count">-</span></p>
                    <p>ÊúÄÁµÇÊõ¥Êñ∞: <span id="last-updated">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let records = [];
        let currentTab = 'dashboard';
        let deferredPrompt;

        // ÂàùÊúü„Éá„Éº„Çø„ÅØÂ§ñÈÉ®API„Åã„ÇâÂãïÁöÑË™≠„ÅøËæº„Åø

        // PWA „Ç§„É≥„Çπ„Éà„Éº„É´ÂØæÂøú
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-prompt').classList.add('show');
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }

        function hideInstallPrompt() {
            document.getElementById('install-prompt').classList.remove('show');
        }

        // Service Worker ÁôªÈå≤
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }

        // „Éá„Éº„ÇøÁÆ°ÁêÜÈñ¢Êï∞
        async function loadFromStorage() {
            const stored = localStorage.getItem('swimRecords');
            if (stored) {
                const data = JSON.parse(stored);
                // „Éá„Éº„Çø„Éê„Éº„Ç∏„Éß„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅÂè§„ÅÑÂ†¥Âêà„ÅØÂº∑Âà∂ÁöÑ„Å´API„Åã„ÇâÂÜçÂèñÂæó
                if (!data.metadata || !data.metadata.version || data.records.length < 183) {
                    console.log('„Éá„Éº„Çø„ÅåÂè§„ÅÑ„Åü„ÇÅ„ÄÅAPI„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åô');
                    localStorage.removeItem('swimRecords');
                    await loadFromAPI();
                } else {
                    records = data.records || [];
                }
            } else {
                // localStorage„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØAPI„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó
                await loadFromAPI();
            }
        }

        async function loadFromAPI() {
            try {
                // GitHub PagesÁí∞Â¢É„Åß„ÅØÁõ¥Êé•JSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø
                const response = await fetch('./data/swim-records.json');
                if (response.ok) {
                    const data = await response.json();
                    records = data.records || [];
                    saveToStorage(); // API„Åã„ÇâÂèñÂæó„Åó„Åü„Éá„Éº„Çø„ÇílocalStorage„Å´‰øùÂ≠ò
                    console.log(`„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${records.length}‰ª∂„ÅÆ„É¨„Ç≥„Éº„Éâ`);
                } else {
                    console.error('JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„ÅÆ„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    records = [];
                }
            } catch (error) {
                console.error('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº:', error);
                records = [];
            }
        }

        function saveToStorage() {
            const data = {
                records: records,
                metadata: {
                    totalRecords: records.length,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0.0"
                }
            };
            localStorage.setItem('swimRecords', JSON.stringify(data));
        }

        function generateId() {
            if (records.length === 0) return '001';
            const maxId = Math.max(...records.map(r => parseInt(r.id)));
            return String(maxId + 1).padStart(3, '0');
        }

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
            
            if (tabName === 'records') {
                renderRecords();
            } else if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'analysis') {
                // ÂàÜÊûê„Çø„Éñ„Å´Âàá„ÇäÊõø„Çè„Å£„ÅüÊôÇ„Å´„Ç∞„É©„Éï„Å®„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                document.querySelector('.chart-container').style.display = 'none';
                document.getElementById('advice-section').style.display = 'none';
                document.getElementById('advice-content').innerHTML = '';
                document.getElementById('debug-info').style.display = 'none';
                updateAnalysis();
            } else if (tabName === 'data-manager') {
                updateDataManager();
            }
        }

        // „É¨„Ç≥„Éº„ÉâË°®Á§∫
        function renderRecords(filteredRecords = null) {
            const tbody = document.getElementById('records-tbody');
            tbody.innerHTML = '';
            
            const recordsToShow = filteredRecords || records;
            
            // Êó•‰ªòÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„Åã„ÇâÔºâ
            const sortedRecords = recordsToShow.sort((a, b) => {
                return new Date(b.Êó•‰ªò) - new Date(a.Êó•‰ªò);
            });
            
            sortedRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.Êó•‰ªò}</td>
                    <td>${record.Á®ÆÁõÆ}</td>
                    <td>${record.Ë∑ùÈõ¢}m</td>
                    <td>${record.„Éó„Éº„É´}</td>
                    <td>${record.„Çø„Ç§„É†}</td>
                    <td>${record.Â§ß‰ºöÂêç}</td>
                    <td>${record.È†Ü‰Ωç}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">ÂâäÈô§</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // „Éï„Ç£„É´„ÇøÊ©üËÉΩ
        function filterRecords() {
            const strokeFilter = document.getElementById('filter-stroke').value;
            const distanceFilter = document.getElementById('filter-distance').value;
            const poolFilter = document.getElementById('filter-pool').value;
            const competitionFilter = document.getElementById('filter-competition').value;
            
            let filtered = records;
            
            if (strokeFilter) {
                filtered = filtered.filter(r => r.Á®ÆÁõÆ === strokeFilter);
            }
            
            if (distanceFilter) {
                filtered = filtered.filter(r => r.Ë∑ùÈõ¢ === distanceFilter);
            }
            
            if (poolFilter) {
                filtered = filtered.filter(r => r.„Éó„Éº„É´ === poolFilter);
            }
            
            if (competitionFilter) {
                filtered = filtered.filter(r => r.Â§ß‰ºöÂêç === competitionFilter);
            }
            
            renderRecords(filtered);
        }

        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊõ¥Êñ∞
        function updateDashboard() {
            document.getElementById('total-records').textContent = records.length;
            
            const butterflyRecords = records.filter(r => r.Á®ÆÁõÆ === '„Éê„Çø„Éï„É©„Ç§' && r.Ë∑ùÈõ¢ === '50');
            if (butterflyRecords.length > 0) {
                const bestTime = Math.min(...butterflyRecords.map(r => parseFloat(r.„Çø„Ç§„É†)));
                document.getElementById('best-time').textContent = bestTime.toFixed(2) + 's';
            }
            
            const competitions = [...new Set(records.map(r => r.Â§ß‰ºöÂêç))].filter(c => c);
            document.getElementById('competitions').textContent = competitions.length;
            
            const firstPlaces = records.filter(r => r.È†Ü‰Ωç === '1‰Ωç').length;
            document.getElementById('first-places').textContent = firstPlaces;
        }

        // ÂàÜÊûêÁîªÈù¢Êõ¥Êñ∞
        function updateAnalysis() {
            const butterflyCount = records.filter(r => r.Á®ÆÁõÆ === '„Éê„Çø„Éï„É©„Ç§').length;
            const freestyleCount = records.filter(r => r.Á®ÆÁõÆ === 'Ëá™Áî±ÂΩ¢').length;
            
            document.getElementById('butterfly-count').textContent = butterflyCount;
            document.getElementById('freestyle-count').textContent = freestyleCount;
            
            // ÊúÄ„ÇÇÂæóÊÑè„Å™Á®ÆÁõÆ
            const strokeCounts = {};
            records.forEach(r => {
                strokeCounts[r.Á®ÆÁõÆ] = (strokeCounts[r.Á®ÆÁõÆ] || 0) + 1;
            });
            
            const bestStroke = Object.keys(strokeCounts).reduce((a, b) => 
                strokeCounts[a] > strokeCounts[b] ? a : b
            );
            document.getElementById('best-stroke').textContent = bestStroke;
            
            // Áõ¥Ëøë„ÅÆÂêë‰∏äÁéá
            const recentRecords = records
                .filter(r => r.Á®ÆÁõÆ === '„Éê„Çø„Éï„É©„Ç§' && r.Ë∑ùÈõ¢ === '50')
                .sort((a, b) => new Date(b.Êó•‰ªò) - new Date(a.Êó•‰ªò))
                .slice(0, 5);
            
            if (recentRecords.length >= 2) {
                const latest = parseFloat(recentRecords[0].„Çø„Ç§„É†);
                const previous = parseFloat(recentRecords[1].„Çø„Ç§„É†);
                const improvement = ((previous - latest) / previous * 100).toFixed(1);
                document.getElementById('recent-improvement').textContent = improvement + '%';
            } else {
                document.getElementById('recent-improvement').textContent = 'N/A';
            }
        }

        // „Éá„Éº„ÇøÁÆ°ÁêÜÁîªÈù¢Êõ¥Êñ∞
        function updateDataManager() {
            document.getElementById('current-data-count').textContent = records.length;
            const stored = localStorage.getItem('swimRecords');
            if (stored) {
                const data = JSON.parse(stored);
                document.getElementById('last-updated').textContent = 
                    new Date(data.metadata.lastUpdated).toLocaleString('ja-JP');
            }
        }

        // „É¨„Ç≥„Éº„ÉâÂâäÈô§
        function deleteRecord(recordId) {
            if (confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                records = records.filter(r => r.id !== recordId);
                saveToStorage();
                renderRecords();
                updateDashboard();
            }
        }

        // „É¨„Ç≥„Éº„ÉâËøΩÂä†
        document.getElementById('record-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // È†Ü‰Ωç„ÅÆÂÄ§„ÇíÂèñÂæóÔºà„Ç´„Çπ„Çø„É†ÂÖ•Âäõ„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®Ôºâ
            let rankValue = formData.get('rank');
            if (rankValue === 'custom') {
                rankValue = formData.get('custom-rank');
            }
            
            const record = {
                id: generateId(),
                Êó•‰ªò: formData.get('date'),
                Á®ÆÁõÆ: formData.get('stroke'),
                Ë∑ùÈõ¢: formData.get('distance'),
                „Éó„Éº„É´: formData.get('pool'),
                „Çø„Ç§„É†: formData.get('time'),
                Á®ÆÂà•: 'Â§ß‰ºö',
                Â§ß‰ºöÂêç: formData.get('competition'),
                „É¨„Éº„Çπ: '',
                È†Ü‰Ωç: rankValue,
                „É°„É¢: formData.get('memo'),
                ÂÖ•ÂäõËÄÖ: '„É¶„Éº„Ç∂„Éº',
                Êõ¥Êñ∞Êó•ÊôÇ: new Date().toISOString()
            };
            
            records.push(record);
            saveToStorage();
            alert('Ë®òÈå≤„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü');
            e.target.reset();
            
            // „Ç´„Çπ„Çø„É†È†Ü‰ΩçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫„Å´„É™„Çª„ÉÉ„Éà
            document.getElementById('custom-rank').style.display = 'none';
            
            if (currentTab === 'records') {
                renderRecords();
            }
            updateDashboard();
            
            // „Éï„Ç£„É´„Çø„Éº„ÇÇÊõ¥Êñ∞
            populateFilters();
        });

        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportData() {
            const data = {
                records: records,
                metadata: {
                    totalRecords: records.length,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0.0"
                }
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `swim-records-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.records && Array.isArray(data.records)) {
                            records = data.records;
                            saveToStorage();
                            renderRecords();
                            updateDashboard();
                            alert('„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
                        } else {
                            alert('ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô');
                        }
                    } catch (error) {
                        alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // „Éá„Éº„Çø„É™„Çª„ÉÉ„Éà
        function resetData() {
            if (confirm('ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂàùÊúüÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                records = initialData.records;
                saveToStorage();
                renderRecords();
                updateDashboard();
                alert('„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
            }
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFromStorage();
            updateDashboard();
            
            // ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Éá„Éï„Ç©„É´„Éà„Å´Ë®≠ÂÆö
            document.getElementById('date').valueAsDate = new Date();
        });

        // Service WorkerÁÑ°ÂäπÂåñÔºà„Ç≠„É£„ÉÉ„Ç∑„É•ÂïèÈ°åËß£Ê±∫„ÅÆ„Åü„ÇÅÔºâ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }

        // „Çø„ÉÉ„ÉÅÊìç‰ΩúÊîπÂñÑ
        document.addEventListener('touchstart', function() {}, {passive: true});
        document.addEventListener('touchmove', function() {}, {passive: true});

        // „Ç∞„É©„ÉïÂ§âÊï∞
        let recordChart = null;

        // „Çø„Ç§„É†Â§âÊèõÈñ¢Êï∞ÔºàÂàÜ:ÁßíÂΩ¢Âºè„ÇíÁßíÊï∞„Å´Â§âÊèõÔºâ
        function parseTimeToSeconds(timeString) {
            if (!timeString) return 0;
            
            // Êó¢„Å´ÁßíÊï∞„ÅÆÂ†¥ÂêàÔºàÂ∞èÊï∞ÁÇπ„ÇíÂê´„ÇÄÊï∞ÂÄ§Ôºâ
            if (/^\d+(\.\d+)?$/.test(timeString)) {
                return parseFloat(timeString);
            }
            
            // ÂàÜ:ÁßíÂΩ¢Âºè„ÅÆÂ†¥ÂêàÔºà‰æã: "01:00.08" „Åæ„Åü„ÅØ "1:30.45"Ôºâ
            const timeMatch = timeString.match(/^(\d{1,2}):(\d{2})\.?(\d{2})?$/);
            if (timeMatch) {
                const minutes = parseInt(timeMatch[1], 10);
                const seconds = parseInt(timeMatch[2], 10);
                const hundredths = timeMatch[3] ? parseInt(timeMatch[3], 10) : 0;
                return minutes * 60 + seconds + hundredths / 100;
            }
            
            // „Åù„ÅÆ‰ªñ„ÅÆÂΩ¢ÂºèÔºà‰æã: "26.15"Ôºâ
            return parseFloat(timeString) || 0;
        }

        // ÁßíÊï∞„ÇíÂàÜ:ÁßíÂΩ¢Âºè„Å´Â§âÊèõÔºàË°®Á§∫Áî®Ôºâ
        function formatSecondsToTime(seconds) {
            if (seconds < 60) {
                return seconds.toFixed(2) + 'Áßí';
            } else {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toFixed(2).padStart(5, '0')}`;
            }
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢Èñ¢Êï∞
        function clearCache() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
            
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            alert('„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }

        // „Éá„Éê„ÉÉ„Ç∞„Éª„ÉÜ„Çπ„ÉàÈñ¢Êï∞
        function testChart() {
            const debugDiv = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            debugDiv.style.display = 'block';
            
            let debug = '';
            
            // Chart.js „ÅÆÁ¢∫Ë™ç
            if (typeof Chart !== 'undefined') {
                debug += '‚úÖ Chart.js Ë™≠„ÅøËæº„ÅøÊàêÂäü<br>';
                debug += `Chart.js „Éê„Éº„Ç∏„Éß„É≥: ${Chart.version}<br>`;
            } else {
                debug += '‚ùå Chart.js „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì<br>';
            }
            
            // CanvasË¶ÅÁ¥†„ÅÆÁ¢∫Ë™ç
            const canvas = document.getElementById('recordChart');
            if (canvas) {
                debug += '‚úÖ CanvasË¶ÅÁ¥†„ÅÇ„Çä<br>';
                debug += `Canvas „Çµ„Ç§„Ç∫: ${canvas.width}x${canvas.height}<br>`;
            } else {
                debug += '‚ùå CanvasË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì<br>';
            }
            
            // „É¨„Ç≥„Éº„Éâ„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
            debug += `üìä Á∑èË®òÈå≤Êï∞: ${records.length}<br>`;
            debug += `„Éê„Çø„Éï„É©„Ç§50mÁü≠Ê∞¥Ë∑Ø: ${records.filter(r => r.Á®ÆÁõÆ === '„Éê„Çø„Éï„É©„Ç§' && r.Ë∑ùÈõ¢ === '50' && r.„Éó„Éº„É´ === 'Áü≠Ê∞¥Ë∑Ø').length}‰ª∂<br>`;
            
            // Á∞°Âçò„Å™„ÉÜ„Çπ„Éà„Ç∞„É©„Éï‰ΩúÊàê
            if (typeof Chart !== 'undefined') {
                try {
                    // Chart.js„ÅÆÂÖ®„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí„ÇØ„É™„Ç¢
                    Chart.helpers.each(Chart.instances, function(instance) {
                        instance.destroy();
                    });
                    
                    // recordChart„Çínull„Å´Ë®≠ÂÆö
                    recordChart = null;
                    
                    // CanvasË¶ÅÁ¥†„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà
                    const chartContainer = document.querySelector('.chart-container div');
                    chartContainer.innerHTML = '<canvas id="recordChart"></canvas>';
                    
                    const canvas = document.getElementById('recordChart');
                    recordChart = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['1Êúà', '2Êúà', '3Êúà'],
                            datasets: [{
                                label: '„ÉÜ„Çπ„Éà„Éá„Éº„Çø',
                                data: [30, 28, 26],
                                borderColor: '#2563eb',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: '„ÉÜ„Çπ„Éà„Ç∞„É©„Éï'
                                }
                            }
                        }
                    });
                    
                    document.querySelector('.chart-container').style.display = 'block';
                    debug += '‚úÖ „ÉÜ„Çπ„Éà„Ç∞„É©„Éï‰ΩúÊàêÊàêÂäüÔºÅ<br>';
                } catch (error) {
                    debug += `‚ùå „Ç∞„É©„Éï‰ΩúÊàê„Ç®„É©„Éº: ${error.message}<br>`;
                }
            }
            
            debugContent.innerHTML = debug;
        }

        // „Ç∞„É©„ÉïÊõ¥Êñ∞Èñ¢Êï∞
        function updateChart() {
            try {
                // „Åæ„ÅöÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Ç∞„É©„Éï„Çí„ÇØ„É™„Ç¢
                document.querySelector('.chart-container').style.display = 'none';
                document.getElementById('advice-section').style.display = 'none';
                document.getElementById('advice-content').innerHTML = '';
                document.getElementById('debug-info').style.display = 'none';

                const stroke = document.getElementById('chart-stroke').value;
                const distance = document.getElementById('chart-distance').value;
                const pool = document.getElementById('chart-pool').value;

                if (!stroke || !distance) {
                    document.querySelector('.chart-container').style.display = 'none';
                    document.getElementById('advice-section').style.display = 'none';
                    // ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                    document.getElementById('advice-content').innerHTML = '';
                    return;
                }

                // „Éá„Éº„Çø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                let filteredRecords = records.filter(record => 
                    record.Á®ÆÁõÆ === stroke && record.Ë∑ùÈõ¢ === distance
                );

                if (pool) {
                    filteredRecords = filteredRecords.filter(record => record.„Éó„Éº„É´ === pool);
                }

                // „Éó„Éº„É´ÈÅ∏Êäû„Å´Âøú„Åò„Å¶ÂØæÊØî„Éá„Éº„Çø„ÇíÂèñÂæó
                let compareRecords = [];
                if (pool === 'Èï∑Ê∞¥Ë∑Ø') {
                    // Èï∑Ê∞¥Ë∑ØÈÅ∏ÊäûÊôÇ„ÅØÁü≠Ê∞¥Ë∑Ø„Éá„Éº„Çø„ÇÇÂèñÂæó
                    compareRecords = records.filter(record => 
                        record.Á®ÆÁõÆ === stroke && record.Ë∑ùÈõ¢ === distance && record.„Éó„Éº„É´ === 'Áü≠Ê∞¥Ë∑Ø'
                    );
                } else if (pool === 'Áü≠Ê∞¥Ë∑Ø') {
                    // Áü≠Ê∞¥Ë∑ØÈÅ∏ÊäûÊôÇ„ÅØÈï∑Ê∞¥Ë∑Ø„Éá„Éº„Çø„ÇÇÂèñÂæó
                    compareRecords = records.filter(record => 
                        record.Á®ÆÁõÆ === stroke && record.Ë∑ùÈõ¢ === distance && record.„Éó„Éº„É´ === 'Èï∑Ê∞¥Ë∑Ø'
                    );
                }

                if (filteredRecords.length === 0 && compareRecords.length === 0) {
                    document.querySelector('.chart-container').style.display = 'none';
                    document.getElementById('advice-section').style.display = 'none';
                    // ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                    document.getElementById('advice-content').innerHTML = '';
                    
                    // „Éá„Éº„Çø„Å™„Åó„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `‚ùå ${stroke} ${distance}m ${pool || '„Åô„Åπ„Å¶'} „ÅÆ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì<br>„Éï„Ç£„É´„ÇøÂæå: ${filteredRecords.length}‰ª∂, ÊØîËºÉ: ${compareRecords.length}‰ª∂`;
                    return;
                }

                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÈö†„Åô
                document.getElementById('debug-info').style.display = 'none';

                // „Éá„Éº„Çø„ÇΩ„Éº„ÉàÔºàÊó•‰ªòÈ†ÜÔºâ
                filteredRecords.sort((a, b) => new Date(a.Êó•‰ªò) - new Date(b.Êó•‰ªò));
                compareRecords.sort((a, b) => new Date(a.Êó•‰ªò) - new Date(b.Êó•‰ªò));

                // „Ç∞„É©„Éï„Éá„Éº„ÇøÊ∫ñÂÇô
                const datasets = [];

                if (filteredRecords.length > 0) {
                    datasets.push({
                        label: `${stroke} ${distance}m (${pool || 'All'})`,
                        data: filteredRecords.map(record => ({
                            x: record.Êó•‰ªò,
                            y: parseTimeToSeconds(record.„Çø„Ç§„É†)
                        })),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: false,
                        tension: 0.1
                    });
                }

                if (compareRecords.length > 0) {
                    const compareLabel = pool === 'Èï∑Ê∞¥Ë∑Ø' ? 'Áü≠Ê∞¥Ë∑ØÂèÇËÄÉ' : 'Èï∑Ê∞¥Ë∑ØÂèÇËÄÉ';
                    datasets.push({
                        label: `${stroke} ${distance}m (${compareLabel})`,
                        data: compareRecords.map(record => ({
                            x: record.Êó•‰ªò,
                            y: parseTimeToSeconds(record.„Çø„Ç§„É†)
                        })),
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5]
                    });
                }

                // „Ç∞„É©„Éï‰ΩúÊàê
                const success = createChart(datasets);
                
                if (success) {
                    // „Ç¢„Éâ„Éê„Ç§„ÇπÁîüÊàê
                    generateAdvice(stroke, distance, pool, filteredRecords);

                    // Ë°®Á§∫
                    document.querySelector('.chart-container').style.display = 'block';
                    document.getElementById('advice-section').style.display = 'block';
                    
                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `‚úÖ „Ç∞„É©„Éï‰ΩúÊàêÊàêÂäüÔºÅ „Éá„Éº„Çø: ${filteredRecords.length}‰ª∂`;
                    setTimeout(() => {
                        debugDiv.style.display = 'none';
                    }, 3000);
                } else {
                    const debugDiv = document.getElementById('debug-info');
                    const debugContent = document.getElementById('debug-content');
                    debugDiv.style.display = 'block';
                    debugContent.innerHTML = `‚ùå „Ç∞„É©„Éï‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`;
                }
                
            } catch (error) {
                console.error('updateChart „Ç®„É©„Éº:', error);
                const debugDiv = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugDiv.style.display = 'block';
                debugContent.innerHTML = `‚ùå „Ç∞„É©„ÉïÊõ¥Êñ∞„Ç®„É©„Éº: ${error.message}`;
            }
        }

        function createChart(datasets) {
            try {
                console.log('createChartÈñãÂßã, datasets:', datasets);
                
                // Chart.js„ÅÆÂÖ®„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí„ÇØ„É™„Ç¢
                if (Chart.instances) {
                    Chart.helpers.each(Chart.instances, function(instance) {
                        instance.destroy();
                    });
                }
                
                // recordChart„Çínull„Å´Ë®≠ÂÆö
                recordChart = null;

                // CanvasË¶ÅÁ¥†„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà
                const chartContainer = document.querySelector('.chart-container div');
                if (!chartContainer) {
                    console.error('Chart container not found');
                    return false;
                }
                
                chartContainer.innerHTML = '<canvas id="recordChart"></canvas>';
                
                const canvas = document.getElementById('recordChart');
                if (!canvas) {
                    console.error('Canvas element not found');
                    return false;
                }
                
                const ctx = canvas.getContext('2d');
                console.log('CanvasÊ∫ñÂÇôÂÆå‰∫Ü');

                // „Éá„Éº„Çø„Çª„ÉÉ„Éà„ÇíÂçòÁ¥î„Å™ÂΩ¢Âºè„Å´Â§âÊèõ
                const labels = [];
                const processedDatasets = [];
                
                datasets.forEach(dataset => {
                    const processedData = dataset.data.map(point => {
                        const date = new Date(point.x);
                        const label = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                        if (!labels.includes(label)) {
                            labels.push(label);
                        }
                        return {
                            label: label,
                            value: point.y
                        };
                    });
                    
                    processedDatasets.push({
                        ...dataset,
                        processedData: processedData
                    });
                });
                
                // „É©„Éô„É´„Çí„ÇΩ„Éº„Éà
                const sortedLabels = labels.sort((a, b) => new Date(a) - new Date(b));
                
                // ÂêÑ„Éá„Éº„Çø„Çª„ÉÉ„Éà„ÇíÊï¥ÁêÜ
                const finalDatasets = processedDatasets.map(dataset => ({
                    ...dataset,
                    data: sortedLabels.map(label => {
                        const dataPoint = dataset.processedData.find(p => p.label === label);
                        return dataPoint ? dataPoint.value : null;
                    })
                }));

                recordChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedLabels,
                        datasets: finalDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Ë®òÈå≤Êé®Áßª„Ç∞„É©„Éï'
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Êó•‰ªò'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '„Çø„Ç§„É†'
                                },
                                reverse: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatSecondsToTime(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('Chart‰ΩúÊàêÊàêÂäü');
                
                return true;
            } catch (error) {
                console.error('„Ç∞„É©„Éï‰ΩúÊàê„Ç®„É©„Éº:', error);
                const debugDiv = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugDiv.style.display = 'block';
                debugContent.innerHTML = `‚ùå „Ç∞„É©„Éï‰ΩúÊàê„Ç®„É©„Éº: ${error.message}<br>Ë©≥Á¥∞: ${error.stack}`;
                return false;
            }
        }

        // ÊúÄËøë„ÅÆË®òÈå≤„ÇíÂàÜÊûê„Åô„ÇãÈñ¢Êï∞
        function analyzeRecentRecords(records) {
            if (records.length < 2) {
                return {
                    trend: 'initial',
                    message: 'Ë®òÈå≤„Åå„Çπ„Çø„Éº„Éà„Åó„Åü„Å∞„Åã„ÇäÔºÅ„Åì„Çå„Åã„Çâ„ÅÆÊàêÈï∑„ÅåÊ•Ω„Åó„Åø„Åß„Åô„Å≠ÔºÅ',
                    detail: 'ÊúÄÂàù„ÅÆ‰∏ÄÊ≠©„ÅåË∏è„ÅøÂá∫„Åõ„Åæ„Åó„Åü„ÄÇÁ∂ôÁ∂ö„ÅØÂäõ„Å™„Çä„ÄÅ„Åå„Çì„Å∞„Çä„Åæ„Åó„Çá„ÅÜÔºÅ'
                };
            }

            // Áõ¥Ëøë5Âõû„ÅÆË®òÈå≤„ÇíÂèñÂæóÔºàÊó•‰ªòÈ†Ü„Å´„ÇΩ„Éº„ÉàÊ∏à„ÅøÔºâ
            const recentCount = Math.min(5, records.length);
            const recentRecords = records.slice(-recentCount);
            const times = recentRecords.map(r => parseTimeToSeconds(r.„Çø„Ç§„É†));
            
            // ÂÇæÂêëÂàÜÊûê
            let improvements = 0;
            let stable = 0;
            let challenges = 0;
            
            for (let i = 1; i < times.length; i++) {
                const diff = times[i-1] - times[i]; // ÂâçÂõû„Å®„ÅÆÂ∑ÆÔºàÊ≠£„Å™„ÇâÂêë‰∏äÔºâ
                if (diff > 0.1) improvements++;
                else if (Math.abs(diff) <= 0.1) stable++;
                else challenges++;
            }
            
            // ÊúÄÊñ∞3Âõû„ÅÆÂπ≥Âùá„Å®Ââç„ÅÆË®òÈå≤„ÅÆÊØîËºÉ
            const latest3 = times.slice(-3);
            const earlier3 = times.slice(-6, -3);
            const latest3Avg = latest3.reduce((a, b) => a + b, 0) / latest3.length;
            const earlier3Avg = earlier3.length > 0 ? earlier3.reduce((a, b) => a + b, 0) / earlier3.length : latest3Avg;
            
            // „Éô„Çπ„Éà„Çø„Ç§„É†„Åã„Çâ„ÅÆ‰ΩçÁΩÆ
            const bestTime = Math.min(...times);
            const latestTime = times[times.length - 1];
            const gapFromBest = latestTime - bestTime;
            
            // „Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
            let trend, message, detail;
            
            if (improvements >= challenges && latest3Avg <= earlier3Avg) {
                trend = 'improving';
                const messages = [
                    'Á¥†Êô¥„Çâ„Åó„ÅÑÂêë‰∏äÂÇæÂêë„Åß„ÅôÔºÅÁ∂ôÁ∂ö„Åó„ÅüÂä™Âäõ„ÅÆÊàêÊûú„ÅåÁèæ„Çå„Å¶„ÅÑ„Åæ„ÅôÔºÅ',
                    'ÁùÄÂÆü„Å´„Çø„Ç§„É†„ÅåÁ∏Æ„Åæ„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ„Åì„ÅÆË™øÂ≠ê„ÅßÊõ¥„Å™„ÇãÈ´ò„Åø„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜÔºÅ',
                    'ÊàêÈï∑„Ç´„Éº„Éñ„ÅåÂè≥ËÇ©‰∏ä„Åå„Çä„Åß„ÅôÔºÅÁ∑¥Áøí„ÅÆË≥™„ÅåÂêë‰∏ä„Åó„Å¶„ÅÑ„ÇãË®ºÊã†„Åß„Åô„Å≠ÔºÅ'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = gapFromBest < 1 ? 
                    '„Éô„Çπ„Éà„Çø„Ç§„É†„Å´Ëø´„ÇãÁ¥†Êô¥„Çâ„Åó„ÅÑ„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥„Åß„ÅôÔºÅ' : 
                    `„Éô„Çπ„Éà„Çø„Ç§„É†„Åæ„Åß${gapFromBest.toFixed(2)}Áßí„ÄÇ„ÇÇ„ÅÜ‰∏ÄÊäº„Åó„Åß„Éñ„É¨„Ç§„ÇØ„Çπ„É´„Éº„Åß„ÅôÔºÅ`;
            } else if (stable > improvements && stable > challenges) {
                trend = 'stable';
                const messages = [
                    'ÂÆâÂÆö„Åó„Åü„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇíÁ∂≠ÊåÅ„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ„Åì„ÅÆÂÆâÂÆöÊÑü„ÅåÊ¨°„ÅÆÈ£õË∫ç„ÅÆÂü∫Áõ§„Åß„ÅôÔºÅ',
                    '„Ç≥„É≥„Çπ„Çø„É≥„Éà„Å´ËâØ„ÅÑ„Çø„Ç§„É†„Çí„Ç≠„Éº„ÉóÔºÅÊäÄË°ìÁöÑ„Å™ÊàêÁÜü„ÇíÊÑü„Åò„Åæ„ÅôÔºÅ',
                    '‰∏ÄÂÆö„É¨„Éô„É´„ÅÆÂÆüÂäõ„Çí„Åó„Å£„Åã„ÇäÁ∂≠ÊåÅÔºÅ„Åì„ÅÆÂÆâÂÆöÊÄß„Åì„Åù„ÅåÁ´∂ÊäÄËÄÖ„ÅÆË®º„Åß„ÅôÔºÅ'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = '„Åì„ÅÆÂÆâÂÆöÊÑü„Åã„Çâ‰∏ÄÊ∞ó„Å´„Éñ„É¨„Ç§„ÇØ„Çπ„É´„Éº„Åô„ÇãÁû¨Èñì„ÅåÂøÖ„ÅöÊù•„Åæ„ÅôÔºÅ';
            } else {
                trend = 'challenging';
                const messages = [
                    'Êñ∞„Åó„ÅÑ„ÉÅ„É£„É¨„É≥„Ç∏„Å´Âèñ„ÇäÁµÑ„Çì„Åß„ÅÑ„ÇãË®ºÊã†„Åß„ÅôÔºÅÊåëÊà¶„ÅØÊàêÈï∑„ÅÆÊ∫ê„Åß„ÅôÔºÅ',
                    '„Çà„ÇäÈ´ò„ÅÑÁõÆÊ®ô„Å´Âêë„Åã„Å£„Å¶„ÅÑ„ÇãÈÅéÁ®ã„Åß„Åô„Å≠ÔºÅ„Åì„ÅÆÁµåÈ®ì„ÅåÂøÖ„ÅöÊ¥ª„Åã„Åï„Çå„Åæ„ÅôÔºÅ',
                    'Êñ∞„Åó„ÅÑÊäÄË°ì„ÇÑÊà¶Áï•„ÇíË©¶Ë°åÈåØË™§‰∏≠ÔºÅ„Åì„ÅÆÁ©çÊ•µÊÄß„ÅåÊàêÂäü„Å∏„ÅÆÈçµ„Åß„ÅôÔºÅ'
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                detail = '„ÉÅ„É£„É¨„É≥„Ç∏„ÅÆÂÖà„Å´„ÅØÂøÖ„ÅöÂ§ß„Åç„Å™ÊàêÈï∑„ÅåÂæÖ„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ';
            }
            
            return { trend, message, detail };
        }

        function generateAdvice(stroke, distance, pool, records) {
            if (records.length === 0) return;

            const bestTime = Math.min(...records.map(r => parseTimeToSeconds(r.„Çø„Ç§„É†)));
            const latestTime = parseTimeToSeconds(records[records.length - 1].„Çø„Ç§„É†);
            const improvement = records.length > 1 ? 
                parseTimeToSeconds(records[0].„Çø„Ç§„É†) - parseTimeToSeconds(records[records.length - 1].„Çø„Ç§„É†) : 0;

            // ÊúÄËøë„ÅÆË®òÈå≤ÂàÜÊûê
            const recentAnalysis = analyzeRecentRecords(records);

            let advice = `<div style="line-height: 1.6;">`;
            
            // Á®ÆÁõÆÂà•„Ç¢„Éâ„Éê„Ç§„Çπ
            const strokeAdvice = {
                '„Éê„Çø„Éï„É©„Ç§': {
                    tips: ['„Çπ„Éà„É™„Éº„É†„É©„Ç§„É≥„ÇíÊÑèË≠ò„Åó„Å¶ÔºÅ', '„Ç≠„ÉÉ„ÇØ„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åå„Éù„Ç§„É≥„ÉàÔºÅ', 'ËÇ©„ÅÆÊüîËªüÊÄß„ÇíÈ´ò„ÇÅ„Çà„ÅÜÔºÅ'],
                    motivation: 'Áæé„Åó„ÅÑ„Éê„Çø„Éï„É©„Ç§„ÅßÊ∞¥Èù¢„ÇíÂà∂Ë¶á„Åó„Çà„ÅÜÔºÅü¶ã'
                },
                'Ëá™Áî±ÂΩ¢': {
                    tips: ['„Çπ„Éà„É≠„Éº„ÇØÊï∞„Çí„Ç´„Ç¶„É≥„Éà„Åó„Å¶„Åø„Çà„ÅÜÔºÅ', '„Ç≠„É£„ÉÉ„ÉÅ„Çí„Åó„Å£„Åã„Çä„Å®ÔºÅ', '„Çø„Éº„É≥„ÅÆ„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ'],
                    motivation: '„Çπ„Éî„Éº„Éâ„ÅÆÁéãÊßò„ÄÅËá™Áî±ÂΩ¢„ÅßÈ¢®„ÅÆ„Çà„ÅÜ„Å´Ê≥≥„Åî„ÅÜÔºÅüåä'
                },
                'ËÉåÊ≥≥„Åé': {
                    tips: ['‰Ωì„ÅÆËª∏„Çí„Åæ„Å£„Åô„Åê„Å´ÔºÅ', '„Éï„É©„ÉÉ„Ç∞„Åã„Çâ„ÅÆË∑ùÈõ¢ÊÑü„ÇíÊé¥„ÇÇ„ÅÜÔºÅ', 'ËÖ∞„ÅÆ‰ΩçÁΩÆ„ÇíÈ´ò„Åè‰øù„Å®„ÅÜÔºÅ'],
                    motivation: 'Á©∫„ÇíË¶ã„Å™„Åå„Çâ„ÄÅÊúÄÈ´ò„ÅÆ„Çø„Ç§„É†„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ‚òÅÔ∏è'
                },
                'Âπ≥Ê≥≥„Åé': {
                    tips: ['‰∏ÄÊéª„Åç‰∏ÄËπ¥„Çä„ÇíÂ§ßÂàá„Å´ÔºÅ', '„Çπ„Éà„É™„Éº„É†„É©„Ç§„É≥„ÅÆÊôÇÈñì„ÇíÈï∑„ÅèÔºÅ', '„Çø„Ç§„Éü„É≥„Ç∞„ÅåÂëΩÔºÅ'],
                    motivation: 'ÊäÄË°ì„ÅÆÂπ≥Ê≥≥„Åé„ÄÅÁæé„Åó„ÅÑ„Éï„Ç©„Éº„É†„ÅßÂãùË≤†ÔºÅüê∏'
                },
                'ÂÄã‰∫∫„É°„Éâ„É¨„Éº': {
                    tips: ['ÂêÑÁ®ÆÁõÆ„ÅÆ„Å§„Å™„Åé„ÇíÊÑèË≠ò„Åó„Å¶ÔºÅ', '„Éö„Éº„ÇπÈÖçÂàÜ„ÅåÈáçË¶ÅÔºÅ', 'ÊúÄÂæå„Åæ„ÅßË´¶„ÇÅ„Å™„ÅÑÂøÉ„ÇíÔºÅ'],
                    motivation: '„Ç™„Éº„É´„É©„Ç¶„É≥„ÉÄ„Éº„ÅÆË®º„ÄÅIM „ÅßÁ∑èÂêàÂäõ„ÇíË¶ã„Åõ„Å§„Åë„Çà„ÅÜÔºÅüèÜ'
                }
            };

            const currentStroke = strokeAdvice[stroke] || strokeAdvice['Ëá™Áî±ÂΩ¢'];
            
            advice += `<p><strong>üéØ ${stroke} ${distance}m „ÅÆÂàÜÊûêÁµêÊûú</strong></p>`;
            advice += `<p>üìà „Éô„Çπ„Éà„Çø„Ç§„É†: <span style="color: #059669; font-weight: bold;">${formatSecondsToTime(bestTime)}</span></p>`;
            advice += `<p>üìä Áõ¥Ëøë„ÅÆ„Çø„Ç§„É†: <span style="color: #2563eb; font-weight: bold;">${formatSecondsToTime(latestTime)}</span></p>`;
            
            if (improvement > 0) {
                advice += `<p>üöÄ Á∑èÂêàÂêë‰∏äÂπÖ: <span style="color: #059669; font-weight: bold;">-${improvement.toFixed(2)}Áßí</span> „Åô„Åî„ÅÑÊàêÈï∑„Åß„ÅôÔºÅ</p>`;
            } else if (improvement < 0) {
                advice += `<p>üí™ „Åæ„Å†„Åæ„Å†‰º∏„Å≥„Åó„Çç„Åå„ÅÇ„Çä„Åæ„ÅôÔºÅÊ¨°„Åì„Åù„Éô„Çπ„ÉàÊõ¥Êñ∞„Å†ÔºÅ</p>`;
            }

            // ÊúÄËøë„ÅÆË®òÈå≤ÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†
            advice += `<br><div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">`;
            advice += `<p><strong>üîç ÊúÄËøë„ÅÆË®òÈå≤ÂàÜÊûê</strong></p>`;
            advice += `<p style="color: #1e40af; font-weight: 600;">${recentAnalysis.message}</p>`;
            advice += `<p style="color: #374151; font-size: 0.95em;">${recentAnalysis.detail}</p>`;
            
            // Ë®òÈå≤Êï∞„Å´Âøú„Åò„ÅüËøΩÂä†„É°„ÉÉ„Çª„Éº„Ç∏
            if (records.length >= 10) {
                advice += `<p style="color: #059669; font-size: 0.9em; margin-top: 8px;">`;
                advice += `üéñÔ∏è ${records.length}Âõû„ÅÆË®òÈå≤ËìÑÁ©çÔºÅÁ∂ôÁ∂öÁöÑ„Å™Âä™Âäõ„ÅÆË≥úÁâ©„Åß„Åô„ÄÇ`;
                advice += `</p>`;
            } else if (records.length >= 5) {
                advice += `<p style="color: #0891b2; font-size: 0.9em; margin-top: 8px;">`;
                advice += `üìä ${records.length}Âõû„ÅÆË®òÈå≤„ÅßÂÇæÂêë„ÅåË¶ã„Åà„Å¶„Åç„Åæ„Åó„ÅüÔºÅ`;
                advice += `</p>`;
            }
            advice += `</div>`;
            
            advice += `<br><p><strong>üí° ${stroke}„ÅÆ„Ç≥„ÉÑ</strong></p>`;
            advice += `<p>„Éª${currentStroke.tips[Math.floor(Math.random() * currentStroke.tips.length)]}</p>`;
            
            advice += `<br><p style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 15px;">`;
            advice += `${currentStroke.motivation}`;
            advice += `</p>`;
            
            advice += `<p style="text-align: center; margin-top: 10px; color: #666; font-style: italic;">`;
            advice += `Á∑¥Áøí„ÅØË£èÂàá„Çâ„Å™„ÅÑ„ÄÇ‰ªäÊó•„ÇÇ„Éô„Çπ„Éà„ÇíÂ∞Ω„Åè„Åù„ÅÜÔºÅ‚ú®`;
            advice += `</p>`;
            
            advice += `</div>`;

            document.getElementById('advice-content').innerHTML = advice;
        }

        // „Éï„Ç£„É´„Çø„Éº„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂàùÊúüÂåñ
        function populateFilters() {
            // „Éó„Éº„É´„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
            const poolSelect = document.getElementById('filter-pool');
            const pools = [...new Set(records.map(r => r.„Éó„Éº„É´))].filter(p => p).sort();
            pools.forEach(pool => {
                const option = document.createElement('option');
                option.value = pool;
                option.textContent = pool;
                poolSelect.appendChild(option);
            });

            // Â§ß‰ºöÂêç„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
            const competitionSelect = document.getElementById('filter-competition');
            const competitions = [...new Set(records.map(r => r.Â§ß‰ºöÂêç))].filter(c => c).sort();
            competitions.forEach(competition => {
                const option = document.createElement('option');
                option.value = competition;
                option.textContent = competition;
                competitionSelect.appendChild(option);
            });

            // Ë®òÈå≤ËøΩÂä†„Éï„Ç©„Éº„É†„ÅÆÂ§ß‰ºöÂêç„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇíÂàùÊúüÂåñ
            const addCompetitionSelect = document.getElementById('competition');
            // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥Ôºà„ÄåÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Äç‰ª•Â§ñÔºâ„Çí„ÇØ„É™„Ç¢
            while (addCompetitionSelect.children.length > 1) {
                addCompetitionSelect.removeChild(addCompetitionSelect.lastChild);
            }
            competitions.forEach(competition => {
                const option = document.createElement('option');
                option.value = competition;
                option.textContent = competition;
                addCompetitionSelect.appendChild(option);
            });
        }

        // È†Ü‰ΩçÈÅ∏Êäû„ÅÆÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        function toggleCustomRank() {
            const rankSelect = document.getElementById('rank');
            const customRankInput = document.getElementById('custom-rank');
            
            if (rankSelect.value === 'custom') {
                customRankInput.style.display = 'block';
                customRankInput.required = true;
            } else {
                customRankInput.style.display = 'none';
                customRankInput.required = false;
                customRankInput.value = '';
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„Å´„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // „É¨„Ç≥„Éº„Éâ„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„ÅüÂæå„Å´„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
            setTimeout(populateFilters, 1000);
        });
    </script>
</body>
</html>